/*!
 * Thorium dbExpress
 * API version : 3.1.5
 * Thorium version 3.1.5 September 2021
 * framework7 v6.x (https://framework7.io) MIT Licensed
 * Thorium builderÂ© Copyright 2018-2021 Nymphide Lab, All Rights Reserved.
*/
var auth={name:"dbExpress Authentification",bundleid:"com.thoriumbuilder.dbexpress.auth",version:"3.1.5",allowRegister:!0,currentUser:{uid:"",displayName:"",email:"",emailVerified:"",isAnonymous:"",creationTime:"",modifyTime:"",lastSignInTime:"",language:"",phoneNumber:"",photoURL:"",token:"",headimage:"",group:0},loginScreen:null,twoFactorsScreen:null,registerScreen:null,profileScreen:null,privacyScreen:null,termsScreen:null,resetPassworScreen:null,pinKeyPad:null,httpMediaRoot:"",getToken:function(){var e=localStorage.getItem(app.id);if(e&&(session=JSON.parse(e),session.token))return session.token},getDbAssetsUrlRoot:function(){return 1==app.device.cordova||1==app.device.capacitor?kRemoteHost+"db/dbassets/":(thoriumCorePlugin.isLocal(),"db/dbassets/")},showResetPasswordScreen:function(e){app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading Reset Password Popup"),auth.resetPassworScreen=app.sheet.create({el:".dbexpress-resetpassword",swipeToClose:!1,backdrop:!0,closeByBackdropClick:!1,closeByOutsideClick:!1,closeOnEscape:!1,animate:!0}),auth.resetPassworScreen.open(!0),app.emit("onShowResetPasswordScreen",e)},showSigninPopup:function(e){app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading Login Popup"),auth.loginScreen||(auth.loginScreen=app.loginScreen.create({el:".dbexpress-signin"})),auth.loginScreen.open(!1),app.emit("onShowLoginScreen",e),setTimeout((function(){$(".apploader").hide()}),1e3)},showTermsPopup:function(e){app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading Terms of Service Popup"),auth.termsScreen=app.popup.create({el:".dbexpress-termsofuse",swipeToClose:!1,backdrop:!0,closeByBackdropClick:!1,closeByOutsideClick:!1,closeOnEscape:!1,animate:!0}),auth.termsScreen.open(!0),app.emit("onShowTermsOfService",this)},showPrivacyPopup:function(e){app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading Privacy Policy Popup"),auth.privacyScreen=app.popup.create({el:".dbexpress-privacypolicy",swipeToClose:!1,backdrop:!0,closeByBackdropClick:!1,closeByOutsideClick:!1,closeOnEscape:!1,animate:!0}),auth.privacyScreen.open(!0),app.emit("onShowPrivacyPolicy",this)},setKeypad:function(e){auth.pinKeyPad=app.keypad.create({inputEl:"#dbexpress-twofactors-pin",containerEl:".numpad-inline-container",toolbar:!1,valueMaxLength:4,dotButton:!1,dotCharacter:".",formatValue:function(e){return e=e.toString(),"...".substring(0,e.length)+"    ".substring(0,4-e.length)},on:{change(e,t){if(4===(t=t.toString()).length&&parseInt(t)>0&&4==t.length){var r=$("#dbexpress-signin-email").val(),a=$("#dbexpress-signin-password").val();auth.signIn(r,a,auth.currentUser.token,parseInt(t))}}}}),auth.pinKeyPad.open()},showTwoFactorsScreen:function(e){e=e||!0,app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading two Factors  Popup"),auth.twoFactorsScreen=app.popup.create({el:".dbexpress-twofactors",swipeToClose:!1,backdrop:!0,closeByBackdropClick:!1,closeByOutsideClick:!1,closeOnEscape:!1,animate:e,on:{opened(){auth.setKeypad()}}}),auth.twoFactorsScreen.open(!0),app.emit("onShow2FactorsScreen",this)},showProfileScreen:function(e){app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading User Profile Popup"),auth.profileScreen=app.popup.create({el:".dbexpress-profile"}),auth.profileScreen.open(!0),app.emit("onShowProfileScreen",e)},showRegisterPopup:function(e){app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading Register Popup"),auth.registerScreen=app.popup.create({el:".dbexpress-register"}),auth.registerScreen.open(!0),app.emit("onShowRegisterScreen",e)},initialize:function(){if(0!=thoriumapi.isLocal()||0!=kDesktopAllowed||!app.device.desktop&&Framework7.support.touch&&(app.device.android||Framework7.device.ios)){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] dbExpress Authentification initialization"),$(".apploader").show();var e=auth.getToken();e?auth.checkCurrentToken(e):auth.signIn(null,null,null,null)}},checkCurrentToken:function(e){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Checking token...");var t=thoriumCorePlugin.httpRoot+kApiRoot+kAuthManagerApi,r=new FormData;r.append("token",e),fetch(t,{method:"post",body:r,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(e){var t=e.code;if(-1012==t)thoriumapi.logEvent(1,"Invalid token: "+e.message+" will try to Signin"),auth.signIn(null,null,null,null);else{if(-1022==t)return auth.showSigninPopup(),void thoriumapi.logEvent(1,"Connection refused: "+e.message);if(-1019==t)return thoriumapi.logEvent(1,"Connection Error: "+e.message+" connecting as Anonymous..."),void auth.signIn(null,null,null,null);if(t<0)auth.showSigninPopup(),thoriumapi.logEvent(2,"Connection Error: "+e.message);else if(0==t){var r={};if(r.token=e.token,auth.currentUser.uid=e.uid,auth.currentUser.displayName=e.displayName,auth.currentUser.email=e.email,auth.currentUser.emailVerified=1==e.emailVerified,auth.currentUser.isAnonymous=1==e.isAnonymous,auth.currentUser.creationTime=e.creationTime,auth.currentUser.modifyTime=e.modifyTime,auth.currentUser.lastSignInTime=e.lastSignInTime,auth.currentUser.language=e.language,auth.currentUser.phoneNumber=e.phoneNumber,auth.currentUser.photoURL=e.photoURL,auth.currentUser.token=e.token,auth.currentUser.headimage=e.headimage,auth.currentUser.group=e.group||0,e.photoURL&&e.photoURL.length>0){var a=auth.getDbAssetsUrlRoot()+e.photoURL+"?rnd="+Math.floor(100*Math.random());$(".dbexpress_avatar").attr("src",a)}else $(".dbexpress_avatar").attr("src","img/defaultavatar.png");$(".dbexpress_avatar").attr("title",auth.currentUser.displayName),$(".user-popover-name").text(auth.currentUser.displayName);try{localStorage.setItem(app.id,JSON.stringify(r))}catch(e){app.dialog.alert(e)}$(".apploader").hide(),app.emit("onAuthStateChanged",auth.currentUser)}}dbExpressData.applyUserRolePermissions()}else app.preloader.hide(),thoriumapi.logError(!0,"Invalid result"),auth.showSigninPopup()})).catch((function(e){app.preloader.hide(),thoriumapi.logError(!0,"Invalid result "+e.message),auth.showSigninPopup()}))},getCountryList:function(){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] loading countries list...");var e=new FormData;e.append("service","_countries"),e.append("token",auth.currentUser.token);var t=thoriumCorePlugin.httpRoot+kApiRoot+kGetDataApi+"?rnd="+Math.floor(100*Math.random());fetch(t,{method:"post",body:e,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(1==thoriumapi.checkResult(e)){var t=e.result,r=document.getElementById("dbexpress-profile-country");t&&t.forEach((function(e){var t=document.createElement("option");t.value=e.iso,t.text=e.nicename,r.appendChild(t)})),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] countries list loaded")}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.auth] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},registerFormPost:function(){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Calling Register web service");var e=new FormData,t=$(".dbexpress-register-password").val(),r=$(".dbexpress-register-email").val(),a=$(".dbexpress-register-displayname").val();e.append("email",r),e.append("password",t),e.append("displayname",a),auth.currentUser.token.length>0&&e.append("token",auth.currentUser.token);var i=thoriumCorePlugin.httpRoot+kApiRoot+kRegisterApi;fetch(i,{method:"post",body:e,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(!e)return thoriumapi.logError(!0,"Invalid Server Response (empty)"),void localStorage.clear();if(e.code<0)return thoriumapi.logError(!0,e.message),void localStorage.clear();if(1==e.code)$("#dbexpress-signin-email").val(r),$("#dbexpress-signin-password").val(t),app.preloader.hide(),auth.showSigninPopup(),auth.registerScreen&&auth.registerScreen.close();else if(0==e.code){var a={};a.token=e.token,localStorage.setItem(app.id,JSON.stringify(a)),auth.currentUser.uid=e.uid,auth.currentUser.displayName=e.displayName,auth.currentUser.email=e.email,auth.currentUser.emailVerified=1==e.emailVerified,auth.currentUser.isAnonymous=1==e.isAnonymous,auth.currentUser.creationTime=e.creationTime,auth.currentUser.modifyTime=e.modifyTime,auth.currentUser.lastSignInTime=e.lastSignInTime,auth.currentUser.language=e.language,auth.currentUser.phoneNumber=e.phoneNumber,auth.currentUser.photoURL=e.photoURL,auth.currentUser.headimage=e.headimage,auth.currentUser.group=e.group||0,auth.registerScreen&&auth.registerScreen.close(),$("#dbexpress-signin-email").val(r),$("#dbexpress-signin-password").val(t),$(".apploader").hide(),app.preloader.hide(),auth.showSigninPopup()}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.auth] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},resetPasswordSubmitPost:function(e){var t=document.querySelector(".dbexpress-resetpassword-form #dbexpress-resetpassword-email"),r=null;if(t)r=t.value;var a=new FormData;a.append("email",r);var i=thoriumCorePlugin.httpRoot+kApiRoot+kresetPassword;fetch(i,{method:"post",body:a,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(app.preloader.hide(),!e)return thoriumapi.logError(!0,"Invalid Server Response (empty)"),void localStorage.clear();e.code<0?thoriumapi.logError(!0,"Error "+e.message):0==e.code&&(auth.resetPassworScreen&&auth.resetPassworScreen.close(),thoriumapi.showToast(kEmailSent,!0,"bottom",4e3,null))})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.auth] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},signInFormPost:function(e){var t=e.querySelector('input[name="dbexpress-signin-email"]').value,r=e.querySelector('input[name="dbexpress-signin-password"]').value;auth.signIn(t,r,"",null)},signIn:function(e,t,r,a){app.preloader.show();var i=new FormData;e&&i.append("email",e),t&&i.append("password",t),a&&i.append("pin",a);var o=thoriumCorePlugin.httpRoot+kApiRoot+kAuthManagerApi;fetch(o,{method:"post",body:i,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(document.getElementById("dbexpress-twofactors-pin").value="    ",auth.pinKeyPad&&auth.pinKeyPad.setValue(""),e){if(-1020==e.code)localStorage.clear(),auth.currentUser.token=e.token,auth.pinKeyPad?thoriumapi.alert(e.message):auth.showTwoFactorsScreen();else if(-1021==e.code)thoriumapi.alert(e.message);else if(-1009==e.code)auth.showSigninPopup(),thoriumapi.logEvent(1,e.message);else if(-1019==e.code)auth.pinKeyPad?thoriumapi.alert(e.message):auth.showTwoFactorsScreen();else if(-1022==e.code)thoriumapi.alert(e.message);else if(-1022==e.code)thoriumapi.alert(e.message);else if(e.code<0)thoriumapi.alert(e.message);else if(0==e.code){var t={};t.token=e.token;try{localStorage.setItem(app.id,JSON.stringify(t))}catch(e){app.dialog.alert(e)}if(auth.currentUser.uid=e.uid,auth.currentUser.displayName=e.displayName,auth.currentUser.email=e.email,auth.currentUser.emailVerified=1==e.emailVerified,auth.currentUser.isAnonymous=1==e.isAnonymous,auth.currentUser.creationTime=e.creationTime,auth.currentUser.modifyTime=e.modifyTime,auth.currentUser.lastSignInTime=e.lastSignInTime,auth.currentUser.language=e.language,auth.currentUser.phoneNumber=e.phoneNumber,auth.currentUser.photoURL=e.photoURL,auth.currentUser.headimage=e.headimage,auth.currentUser.token=e.token,auth.currentUser.group=e.group||0,$(".dbexpress_avatar").attr("title",auth.currentUser.displayName),e.photoURL&&e.photoURL.length>0){var r=auth.getDbAssetsUrlRoot()+e.photoURL+"?rnd="+Math.floor(100*Math.random());$(".dbexpress_avatar").attr("src",r)}else $(".dbexpress_avatar").attr("src","img/defaultavatar.png");$(".user-popover-name").text(auth.currentUser.displayName),auth.loginScreen&&auth.loginScreen.close(),auth.twoFactorsScreen&&auth.twoFactorsScreen.close(),auth.registerScreen&&auth.registerScreen.close(),$(".apploader").hide(),app.preloader.hide(),app.emit("onAuthStateChanged",auth.currentUser)}}else thoriumapi.logError(!0,err.message),auth.showSigninPopup()})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.auth] Request failed "+e),thoriumapi.logError(!0,e.message),auth.showSigninPopup()}))},saveProfile:function(){for(var e=document.getElementById("dbexpress-profile-form"),t=document.getElementById("dbexpress-profile-form").elements,r=0;o=t[r++];)if(!o.checkValidity())return app.preloader.hide(),"function"==typeof o.reportValidity&&o.reportValidity(),void thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Missing Mandatory fields for Form with id ["+e.id+"]");var a=auth.getToken(),i=new FormData;i.append("token",a),i.append("uid",auth.currentUser.uid);var o;for(t=document.getElementById("dbexpress-profile-form").elements,r=0;o=t[r++];){var n=o.name.replace("dbexpress-profile-","");if("photourl"!=n&&"headimage"!=n&&"file"!=o.type)i.append(n,o.value);else if("file"==o.type){var l=o.id,s=$("#"+l);if(s){var p=s.data("data-blob")||"",u=n.replace("-fileinput","");p.length>0&&i.append(u,p)}}}var d=thoriumCorePlugin.httpRoot+kApiRoot+kSetProfileApi;fetch(d,{method:"post",body:i,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(e){if(-23e3==e.code)thoriumapi.logError(!0,"User already exists ("+email+")");else if(e.code<0)thoriumapi.logError(!0,e.message);else if(0==e.code){if(auth.currentUser.displayName=e.displayName,auth.currentUser.email=e.email,auth.currentUser.emailVerified=e.emailVerified,auth.currentUser.isAnonymous=e.isAnonymous,auth.currentUser.creationTime=e.creationTime,auth.currentUser.modifyTime=e.modifyTime,auth.currentUser.lastSignInTime=e.lastSignInTime,auth.currentUser.language=e.language,auth.currentUser.phoneNumber=e.phoneNumber,auth.currentUser.photoURL=e.photoURL,auth.currentUser.token=e.token,auth.currentUser.headimage=e.headimage,$(".dbexpress_avatar").attr("title",auth.currentUser.displayName),e.photoURL&&e.photoURL.length>0){var t=auth.getDbAssetsUrlRoot()+e.photoURL+"?rnd="+Math.floor(100*Math.random());$(".dbexpress_avatar").attr("src",t)}$(".user-popover-name").text(auth.currentUser.displayName),app.preloader.hide(),auth.profileScreen.close()}}else thoriumapi.logError(!0,err.message),auth.showSigninPopup()})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.auth] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},loadProfileScreen:function(){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Loading User Profile"),app.preloader.show();var e=auth.getToken(),t=new FormData;if(e)if(t.append("token",e),auth.currentUser.email){t.append("email",auth.currentUser.email);var r=thoriumCorePlugin.httpRoot+kApiRoot+kGetProfileApi;fetch(r,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(e){if(e.code<0)thoriumapi.logError(!0,"error "+e.code+": "+e.message);else if(0==e.code){if(auth.currentUser.uid=e.uid,auth.currentUser.displayName=e.displayName,auth.currentUser.email=e.email,auth.currentUser.emailVerified=1==e.emailVerified,auth.currentUser.isAnonymous=1==e.isAnonymous,auth.currentUser.creationTime=e.creationTime,auth.currentUser.modifyTime=e.modifyTime,auth.currentUser.lastSignInTime=e.lastSignInTime,auth.currentUser.language=e.language,auth.currentUser.phoneNumber=e.phoneNumber,auth.currentUser.photoURL=e.photoURL,$(".profile-displayname").text(e.displayName),$(".profile-shortdesc").text(e.shortdesc),e.country&&e.country.length>0?$(".dbexpress-profile-flag").css("background-image","url("+thoriumCorePlugin.httpRoot+kApiRoot+"flags/4x3/"+e.country.toLowerCase()+".svg)"):$(".dbexpress-profile-flag").css("background-image",""),e.photoURL&&e.photoURL.length>0){var t=auth.getDbAssetsUrlRoot()+e.photoURL+"?rnd="+Math.floor(100*Math.random());$("#dbexpress-profile-photourl").css("background-image","url("+t+")")}else $("#dbexpress-profile-photourl").css("background-image","url(./img/defaultavatar.png)");if(e.headimage&&e.headimage.length>0){t=auth.getDbAssetsUrlRoot()+e.headimage+"?rnd="+Math.floor(100*Math.random());$("#dbexpress-profile-headimage").css("background-image","url("+t+")")}else $("#dbexpress-profile-headimage").css("background-image","url(./img/defaultimg.png)");$("#dbexpress-profile-photourl-fileinput").data("data-blob",""),$("#dbexpress-profile-photourl-fileinput").data("data-type",""),$("#dbexpress-profile-photourl-fileinput").data("data-filename",""),$("#dbexpress-profile-photourl-rotate")&&$("#dbexpress-profile-photourl-rotate").hide(),$("#dbexpress-profile-photourl-remove")&&$("#dbexpress-profile-photourl-remove").hide(),$(".dbexpress-profile-email").val(e.email),$(".dbexpress-profile-displayname").val(e.displayName),$(".dbexpress-profile-phonenumber").val(e.phoneNumber),$(".dbexpress-profile-recoveryemail").val(e.recoveryemail),$(".dbexpress-profile-bio").val(e.bio),$(".dbexpress-profile-firstname").val(e.firstname),$(".dbexpress-profile-lastname").val(e.lastname),$(".dbexpress-profile-gender").val(e.gender),$(".dbexpress-profile-address").val(e.address),$(".dbexpress-profile-city").val(e.city),$(".dbexpress-profile-country").val(e.country),$(".dbexpress-profile-zip").val(e.zip),$(".dbexpress-profile-shortdesc").val(e.shortdesc),$(".dbexpress-profile-birthday").val(e.birthday),$(".dbexpress-profile-state").val(e.state),$(".dbexpress_avatar").attr("title",auth.currentUser.displayName),$(".user-popover-name").text(auth.currentUser.displayName),$(".apploader").hide(),app.preloader.hide(),auth.showProfileScreen()}}else thoriumapi.logError(!0,result)})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.auth] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))}else thoriumapi.logError(!0,"Invalid email");else thoriumapi.logError(!0,"Invalid Token")},handleAvatarPopup:function(e,t){e.preventDefault(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.auth] Click/Touch on User Monitor");var r=document.querySelector(".dbexpress-signin .toolbar .title").textContent||"Sign In",a=document.querySelector(".dbexpress-register .navbar .title").textContent||"Register",i=document.querySelector(".dbexpress-profile .navbar .title").textContent||"Profile",o=auth.currentUser;o&&1!=o.isAnonymous?app.actions.create({buttons:[[{text:i,bold:!0,onClick:function(e){auth.loadProfileScreen()}}],[{text:kLogout,color:"red",onClick:function(e){app.dialog.confirm(kLogout+"?",(function(){auth.logout()}))}}]]}).open(!0):1==(auth.allowRegister||!1)&&app.actions.create({buttons:[[{text:a,bold:!0,onClick:function(e){auth.showRegisterPopup(e)}}],[{text:r,bold:!0,onClick:function(e){auth.showSigninPopup(e)}}]]}).open(!0)},logout:function(){app.preloader.show();var e=auth.getToken(),t=new FormData;e&&t.append("token",e);var r=thoriumCorePlugin.httpRoot+kApiRoot+kSignOutApi;fetch(r,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){1==thoriumapi.checkResult(e)&&(e.code<0?thoriumapi.logError(!0,"error "+e.code+": "+e.message):0==e.code&&(localStorage.clear(),location.reload()))})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.auth] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))}},dbExpressMaps={name:"Thorium Builder JSON API Plugin",bundleid:"com.thoriumbuilder.dbexpress.map",version:"3.0.0",initAllopenStreetMaps:function(e){for(var t=document.querySelectorAll(".openstreetmap-api"),r=0;r<t.length;r++){var a=t[r],i=a.getAttribute("data-loaded")||"false",o=a.getAttribute("data-dbsource")||null;if("false"==i||1==e)openStreetMapPlugin.showPreloader(),openStreetMapPlugin.initMap(a.id)&&"sqlite"==o&&void 0!==dbExpressMaps&&(thoriumapi.logEvent(0,"[com.thoriumbuilder.leaflet] Get Markers from Sqlite for OSM Map with id:"+a.id),dbExpressMaps.loadPlaces(a,"osm"));else thoriumapi.logEvent(0,"[com.thoriumbuilder.leaflet] OSM Map with ID ["+a.id+"] already initialized")}},initAllGoogleMaps:function(e){for(var t=document.querySelectorAll(".googlemapAPI"),r=0;r<t.length;r++){var a=t[r],i=a.getAttribute("data-loaded")||"false",o=a.getAttribute("data-dbsource")||null;"false"!=i&&1!=e||"sqlite"!=o?thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.maps] Google Map with ID ["+a.id+"] already initialized"):(app.preloader.show(),thoriumapi.logEvent(0,"[com.thoriumbuilder.leaflet] Get Markers from Sqlite for OSM Map with id:"+a.id),dbExpressMaps.loadPlaces(a,"googlemap"))}},loadPlaces:function(e,t,r){r=r||"googlemap",thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.maps] map engine initialization ["+r+"]"),dbExpressData.getRepeaterData(e,null,!1,"")},addMarkersToMap:function(e,t,r){if("undefined"!=typeof openStreetMapPlugin||"osm"!=r)if("undefined"!=typeof googleMapPlugin||"googlemap"!=r){var a=e.closest(".page-content");a&&app.preloader.showIn(a);var i=e.getAttribute("data-target")||"",o=0;thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.maps] adding items to OSM map");var n=e.getAttribute("data-img-field")||null,l=e.getAttribute("data-name-field")||null,s=e.getAttribute("data-address-field")||null,p=e.getAttribute("data-description-field")||null,u=e.getAttribute("data-subtitle-field")||null,d=e.getAttribute("data-badge-field")||null,c=e.getAttribute("data-latitude-field")||null,m=e.getAttribute("data-longitude-field")||null,h=e.getAttribute("data-rating-field")||null,g=e.getAttribute("data-service")||null;for(var b in t){var f=t[b];if(f.target=i,f.uid=f.uid,f.pk=f.pk,f.service=g,l&&(f.name=f[l]),s&&(f.address=f[s]),p&&(f.desc=f[p]),u&&(f.subtitle=f[u]),d&&(f.badge=f[d]),c&&(f.latitude=f[c]),m&&(f.longitude=f[m]),h&&(f.rating=f[h]),n){var v=f[n];v&&v.length>0&&(f.locimage="./db/dbassets/"+v)}var y=f.uid,A=parseFloat(f.latitude),x=parseFloat(f.longitude);if(f.uid=y,A&&x)if("osm"==r){var k=e.data;openStreetMapPlugin.addMarkerAt(k,A,x,f)}else if("googlemap"==r){var E=new google.maps.LatLng(A,x);googleMapPlugin.addMarker(e.map,E,f.name,f.uid,f.address,f.locimage,f.desc,f.subtitle,f.badge,f.rating,f.target,null,f.pk,f.service)}if((o+=1)>100)break}app.preloader.hide(),a&&app.preloader.hideIn(a)}else app.preloader.hide();else app.preloader.hide()},loadPlacesCallback:function(e,t){if("undefined"!=typeof googleMapPlugin){var r,a=e.getDiv();for(var i in a&&(a.getAttribute("id")||"",r=a.getAttribute("data-target")||""),t){var o=t[i],n=parseFloat(o.latitude),l=parseFloat(o.longitude),s=new google.maps.LatLng(n,l),p=o.name||"",u=hash_encode(o.pk),d=o.address,c=o.img_name,m=o.description,h=o.subtitle,g=o.badge,b=o.rating;0!=n&&0!=l&&googleMapPlugin.addMarker(e,s,p,u,d,c,m,h,g,b,r)}}},initDisplayerMap:function(e,t,r){if(t&&r){var a=e.getAttribute("data-engine")||null;if(a||"undefined"==typeof openStreetMapPlugin?a||"undefined"==typeof googleMapPlugin||(a="googlemap"):a="osm",thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.maps] Loading Displayer Map with Engine ["+a+"]"),"osm"==a&&"undefined"!=typeof openStreetMapPlugin){var i=openStreetMapPlugin.initMap(e.id);if(i){var o={};o.latitude=t,o.longitude=r,o.name=t+";"+r,openStreetMapPlugin.addMarkerAt(i,t,r,o),i.panTo(new L.LatLng(t,r))}}else if("googlemap"==a&&"undefined"!=typeof googleMapPlugin){googleMapPlugin.initializeMap(e.id);var n=new google.maps.LatLng(parseFloat(t),parseFloat(r));googleMapPlugin.addMarker(e.map,n,t+";"+r),e.map.setCenter(n)}}else e.style.display="none"}},dbExpressData={name:"Thorium Builder JSON API Plugin",bundleid:"com.thoriumbuilder.dbexpress.data",version:"3.0.0",allowInfinite:!0,currentRecord:{},onAuthStateChanged:function(){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Initializing dbExpress API"),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Checking Repeaters State");const e=document.querySelectorAll(".infinite-scroll-preloader");for(var t=0;t<e.length;t++){e[t].style.visibility="hidden"}dbExpressData.applyUserRolePermissions(),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Checking DbExpress Displayers State");const r=document.querySelectorAll(".dbexpress-displayer");for(t=0;t<r.length;t++){var a=r[t];if("true"!=a.getAttribute("data-loaded")){a.style.visibility="hidden";var i=a.getAttribute("data-service")||null,o=document.querySelector(".page-current");i&&o&&dbExpressData.loadRecord(o,i,null)}}dbExpressData.initAllRepeaters(!0),"undefined"!=typeof openStreetMapPlugin&&dbExpressMaps.initAllopenStreetMaps(!0),"undefined"!=typeof googleMapPlugin&&dbExpressMaps.initAllGoogleMaps(!0),thoriumCorePlugin.initForms()},initAllRepeaters:function(e){const t=document.querySelectorAll(".dbexpress-virtual-list-content");for(var r=0;r<t.length;r++){var a=t[r];if("true"!=a.getAttribute("data-loaded")||1==e)a.getAttribute("data-service")||null?dbExpressData.getRepeaterData(a):thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Service is not defined for Repeater with ID ["+a.id+"]")}},applyUserRolePermissions:function(e){if(e=e||document){const i=e.querySelectorAll("* [data-permission]");for(var t=0;t<i.length;t++){var r,a=i[t];if((a.getAttribute("data-permission")||0)>auth.currentUser.group)"none"!=(r=a.style.display)&&a.setAttribute("data-display",r),a.style.visibility="hidden",a.style.display="none";else a.style.visibility="visible","none"==(r=a.getAttribute("data-display")||"block")&&(r="block"),a.style.display=r}}},addItemToAllRepeaters:function(e,t){t.service=e;const r=document.querySelectorAll(".dbexpress-virtual-list-content[data-service='"+e+"']");for(var a=0;a<r.length;a++){var i=r[a],o=app.virtualList.get(i);o?(o.items.length?(t.dataindex=o.items.length,o.prependItem(t)):(t.dataindex=0,o.items=[],o.prependItem(t)),o.update()):1==i.classList.contains("dbexpress-horizontal-list")&&dbExpressData.getRepeaterData(i)}},replaceItemInAllRepeaters:function(e,t){t.service=e;const r=document.querySelectorAll(".dbexpress-virtual-list-content[data-service='"+e+"']");for(var a=0;a<r.length;a++){var i=r[a],o=app.virtualList.get(i);if(o){for(var n=0;n<o.items.length;n++)o.items[n].uid==t.uid&&(t.dataindex=n,o.replaceItem(n,t));o.update()}else 1==i.classList.contains("dbexpress-horizontal-list")&&dbExpressData.getRepeaterData(i)}if(t.uid){const r=document.querySelectorAll(".dbexpress-virtual-list-content .virtual-list-media[data-img-name='"+t.uid+"-1.jpg']");for(a=0;a<r.length;a++){var l=(i=r[a]).getAttribute("data-img-name");i.style.backgroundImage="url('db/dbassets/"+l+"?rnd="+Math.floor(100*Math.random())+"')"}const o=document.querySelectorAll(".dbexpress-displayer[data-service='"+e+"']");for(a=0;a<o.length;a++){i=o[a];dbExpressData.fillDisplayerFromMemoryData(i,t)}const n=document.querySelectorAll(".dbexpress-image-content");for(a=0;a<n.length;a++){l=(i=n[a]).getAttribute("data-img-name");i.style.backgroundImage="url('db/dbassets/"+l+"?rnd="+Math.floor(100*Math.random())+"')"}}},showVerticalRepeaterZoom:function(e,t){thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Show Horizontal Repeater Photo Browser");var r=[],a=0,i=0,o=t.querySelector(".dbexpress-image-content");if(o)var n=o.getAttribute("data-img-name");for(var l=e.querySelectorAll(".item-dbexpress"),s=0;s<l.length;s++){var p=l[s];if(0==p.classList.contains("templaterow")){const e=p.querySelector(".dbexpress-image-content");if(e){var u=e.getAttribute("data-img-name");u==n&&(a=i);var d={};d.url=auth.getDbAssetsUrlRoot()+u,r.push(d),i+=1}}}thoriumCorePlugin.showPhotoBrowser(r,a)},fillSmartSelect:function(e,t){if("true"!=e.getAttribute("data-loaded")){var r=e[0].closest(".page-content");r&&app.preloader.showIn(r);var a=e.getAttribute("data-service-field")||null;if(a){var i='<option value="" selected disabled class="disabled"></option>',o=thoriumCorePlugin.httpRoot+kApiRoot+kGetDataApi+"?rnd="+Math.floor(100*Math.random()),n={method:"post"},l=new FormData;l.append("service",t),l.append("token",auth.currentUser.token),n.body=l,fetch(o,n).then(thoriumapi.status).then(thoriumapi.json).then((function(t){if(t&&t.code>=0){var o=0,n=e.getAttribute("data-value")||null,l=t.result,s='<option value="{{pk}}" {{selected}} >'+a+"</option>",p=(o=0,e.getAttribute("data-parent-pk")||null);if(l){e.getAttribute("data-service-field");for(var u in l){l[u].dataindex=o,o+=1;var d=s,c=a;for(var m in l[u])p&&"pk"==m&&l[u][m]==p?(d=d.replace("{{selected}}","selected"),!0):d=d.replace("{{selected}}",""),d=d.replace("{{"+m+"}}",l[u][m]),c=c.replace("{{"+m+"}}",l[u][m]);i+=d}if(e.innerHTML=i,p){var h=e.closest(".smart-select");(g=app.smartSelect.get(h))&&g.setValue(p),"select"==e.tagName.toLowerCase()&&(e.value=p)}if(n){var g;if(h=e.closest(".smart-select"))(g=app.smartSelect.get(h))&&g.setValue(n);"select"==e.tagName.toLowerCase()&&(e.value=n)}e.setAttribute("data-loaded","true"),r&&app.preloader.hideIn(r)}}})).catch((function(e){app.emit("dbExpressDataLoadError",$(this),e),thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))}else thoriumapi.logEvent(1,"[com.thoriumbuilder.dbexpress] Service Field is not defined for Form Input with ID ["+e.id+"] ")}},submitForm:function(e,t){var r=e.target;if(0==app.input.validateInputs(r))return void thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Missing Mandatory fields for Form with id ["+r.id+"]");var a=t.attr("data-mode")||null;if(3!=a&&4!=a&&5!=a)return;if(0==r.classList.contains("dbexpress-form"))return;e.preventDefault,thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Submiting Form with id ["+r.id+"]"),thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Formating Data for Form with id ["+r.id+"]");for(var i=new FormData,o=0;o<r.length;o++){const e="_alias",t=["name"+e,"id"+e,"description"+e,"this"+e,"title"+e,"submit"+e];var n,l=r[o].name;!0===t.includes(l)&&(l=l.replaceAll(e,"")),l.length>0&&(n=r.querySelector("input[name="+l+"]"));var s,p=r[o].type;if(n&&"text"==p?(n.getAttribute("type"),s=n.getAttribute("data-date-type")||null):null,"radio"==p)!0===r[o].checked&&i.append(l,r[o].value);else if("checkbox"==p)i.append(l,r[o].checked);else if("submit"==p);else if("file"==p){if(1==("true"==r[o].getAttribute("data-modified")||!1)){var u=r[o].id,d=$("#"+u);if(d){var c=d.data("data-blob");c||(c=""),-1==l.indexOf("-fileinput")&&(l+="-fileinput"),i.append(l,c)}}}else if(!s||"datetime-local"!=s&&"date"!=s)i.append(l,r[o].value);else{var m=r[o].getAttribute("data-timestamp")||null;m?i.append(l,m):i.append(l,r[o].value)}}var h=thoriumCorePlugin.httpRoot+kApiRoot+kSetDataApi,g=document.querySelector(".page-current");if(4==a||5==a){var b=g.getAttribute("data-record-uid")||null;i.append("uid",b)}else if(3==a){var f=g.getAttribute("data-record-pk")||null;"null"==f&&(f=null);var v=g.getAttribute("data-record-service")||null;v!=y&&v&&f&&i.append("fk_"+v,f)}var y=t.attr("data-service")||null;y&&i.append("service",y),i.append("token",auth.currentUser.token);var A="",x=!1,k="multipart/form-data",E=!0,w="",S="",D=0;const C=t.attr("data-form-beforesubmit");if(C){const e=window[C];var R={};R.formdata=i,R.headers=A,R.url=h,R.crossDomain=x,R.contentType=k,R.async=E,R.username=w,R.password=S,R.timeout=D;var P=[r,R];if("function"==typeof e){var U=e.apply(this,P);thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Function ["+C+"] Called for Form with id ["+r.id+"]"),U&&(i=U.formdata,A=U.headers,h=U.url,x=U.crossDomain,k=U.contentType,E=U.async,w=U.username,S=U.password,D=U.timeout)}else{var T='[com.thoriumbuilder.core] An error occured "'+C+'" is not an existing function';thoriumapi.logEvent(2,T)}}app.preloader.show(),thoriumapi.logEvent(0,"Sending Data to: ["+h+"] from Form with id ["+r.id+"]"),app.request({url:h,data:i,method:"post",crossDomain:x,contentType:k,headers:A,timeout:D,dataType:"text",processData:!0,username:w,password:S,async:E,error(e,a){app.preloader.hide();var i=t.attr("data-form-error-message")||"",o=(e.responseText+" "+e.statusText).trim();thoriumapi.logEvent(2,"[com.thoriumbuilder.core] Form Error: ["+o+"] when submitting Form with id ["+r.id+"]"),i.length>0?thoriumCorePlugin.showAlert(i):thoriumCorePlugin.showAlert("An error occured ["+e.responseText+" "+e.statusText+"] when submitting Form with id ["+r.id+"]"),app.emit("userFormError",o,r,a,e)},success(i,o,n){app.preloader.hide();try{var l=JSON.parse(i)}catch(e){return thoriumapi.logEvent(2,"Error "+e),void app.dialog.alert(e)}if(l&&l.code<0)return thoriumapi.logEvent(2,"Error "+l.code+" "+l.message),void app.dialog.alert(l.message);if(!l)return thoriumapi.logEvent(2,"Error, invalid result"),void app.dialog.alert("Error, invalid result");var s={};l.result&&l.result.length>0&&(s=l.result[0]);var p=1==l.inserted,u=t.attr("data-service")||null;1==p&&u&&3==a?dbExpressData.addItemToAllRepeaters(u,s):0==p&&u&&3!=a&&dbExpressData.replaceItemInAllRepeaters(u,s),thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Form with id ["+r.id+"] Sent with Success");var d=t.attr("data-form-message")||null;if(d&&d.length>0&&thoriumCorePlugin.showAlert(d),app.emit("userFormSuccess",i,r,o,n),"true"==(t.attr("data-reset-form")||"false")){thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Form Reset"),e.target.reset(),$("#"+e.target.id+" .text-editor").each((function(e){var t=app.textEditor.get("#"+e.id);t&&t.setValue("")}));for(var c=r.querySelectorAll("select"),m=0;m<c.length;m++){c[m].value="";var h=r.querySelector(".smart-select .item-after");h&&(h.innerText="")}$(".firebase_document_preview").css("background-image",""),$(".input-filename span").html(""),$(".firebase_fileupload-rotate").hide(),$(".firebase_fileupload-remove").hide(),$(".input-filename i").hide()}var g=t.attr("data-return-function")||null;if(g){thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Form with id ["+r.id+"] : Calling JS function ["+g+"]");var b=window[g],f=[r,i,o,n];if("function"==typeof b){b.apply(this,f);app.preloader.hide(),thoriumapi.logEvent(0,"[com.thoriumbuilder.core] JS function ["+g+"] called successfully when submitting Form with id ["+r.id+"]")}else{app.preloader.hide();var v='An error occured "'+g+'" is not an existing function';thoriumapi.logEvent(2,"[com.thoriumbuilder.core] JS function ["+g+"] called with Error: ["+v+"] when submitting Form with id ["+r.id+"]"),thoriumCorePlugin.showAlert(v),app.emit("userFormError",v,r,o,n)}}var y=t.attr("data-form-postprocess")||0;0==y?thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Form Sent"):1==y?(thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Going Back to Previous Page"),thoriumCorePlugin.backToPreviousPage()):2==y&&(thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Reloading Home Page"),thoriumCorePlugin.reloadHomePage())}})},executeRepeaterFullText:function(e){var t=e.value,r=e.form,a="true"==r.getAttribute("data-custom-search")||!1;if(t&&t.length>0&&1==a){var i=r.getAttribute("data-search-container"),o=document.querySelector(i);if(o){o.setAttribute("data-loaded",!1);var n=o.getAttribute("data-parentuid")||null;dbExpressData.getRepeaterData(o,n,!1,t)}}},deleteRecord:function(e,t,r,a,i){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.data] delete record with id ["+a+"] from service ["+t+"]"),app.preloader.show();var o=new FormData;o.append("token",auth.currentUser.token),o.append("service",t),o.append("uid",r),o.append("pk",a);var n=thoriumCorePlugin.httpRoot+kApiRoot+kDeleteDataApi;fetch(n,{method:"post",body:o,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(e&&e.code<0)app.preloader.hide(),app.dialog.alert(e.message);else if(e&&0==e.code){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.data] record with id ["+a+"] from service ["+t+"] deleted");const e=document.querySelectorAll(".dbexpress-virtual-list-content[data-service='"+t+"']");for(var o=e.length-1;o>=0;o--){var n=e[o],l=app.virtualList.get(n);if(l){for(var s=0;s<l.items.length;s++)l.items[s].uid==r&&l.deleteItem(s);l.update()}else{const e=n.querySelectorAll(".item-dbexpress[data-uid='"+r+"']");for(var p=0;p<e.length;p++){const t=e[p];t&&t.remove()}}}app.preloader.hide(),1==i&&thoriumCorePlugin.backToPreviousPage()}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},handleDelete:function(e){var t=event.target.getAttribute("data-message")||"Delete?";app.dialog.confirm(t,(function(){var t=!0;e.closest(".dbexpress-virtual-list-content")&&(t=!1);e.closest(".dbexpress-displayer")&&(t=!0);var r=e.getAttribute("data-pk")||null,a=e.getAttribute("data-uid")||null,i=e.getAttribute("data-service")||null;"null"==r&&(r=null),"null"==a&&(a=null),"null"==i&&(i=null),i&&r&&a&&dbExpressData.deleteRecord(e,i,a,r,t)}))},getRepeaterData:function(e,t,r,a,i,o){r=r||!1,a=a||null,i=i||null,o=o||null;var n=e.getAttribute("data-service")||null;if(!n)return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] Service not defined for Repeater with ID ["+e.id+"]"),void app.preloader.hide();if(1==r){if(1==("true"==e.getAttribute("data-fetched")||!1))return void(dbExpressData.allowInfinite=!0)}else{e.setAttribute("data-offset",0),e.setAttribute("data-fetched",!1);const t=document.querySelectorAll(".infinite-scroll-preloader");for(var l=0;l<t.length;l++){t[l].style.visibility="hidden"}dbExpressData.allowInfinite=!0}var s=parseInt(e.getAttribute("data-offset")||0),p=$("#"+e.id);if(!p)return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] Virtual List not found for Repeater with ID ["+e.id+"]"),dbExpressData.allowInfinite=!0,void app.preloader.hide();1!=r&&app.preloader.show();var u=app.virtualList.get(p),d=thoriumCorePlugin.httpRoot+kApiRoot+kGetDataApi+"?rnd="+Math.floor(100*Math.random());thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Get data for Repeater with ID ["+e.id+"] from url ["+d+"]");var c={method:"post"},m=new FormData;if(m.append("service",n),m.append("token",auth.currentUser.token),t&&t.length>0){(h=e.getAttribute("data-foreign-key")||null)&&(m.append("parentpk",t),m.append("foreignkey",h),e.setAttribute("data-parent-pk",t),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Adding Filter [Parent key "+h+"="+t+"]"))}else{var h=e.getAttribute("data-foreign-key")||null,g=e.getAttribute("data-parent-pk")||null;h&&g&&(m.append("parentpk",g),m.append("foreignkey",h))}if(i&&o)m.append("extraparentpk",o),m.append("extraforeignkey",i),e.setAttribute("data-parent-fk",i),e.setAttribute("data-parent-fk-value",o);else{i=e.getAttribute("data-parent-fk")||null,o=e.getAttribute("data-parent-fk-value")||null;i&&o&&(m.append("extraparentpk",o),m.append("extraforeignkey",i))}a&&a.length>0&&(m.append("search",a),e.setAttribute("data-search",a),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Adding Filter [ full text search with value "+a+"]"));const b=e.getAttribute("data-filter-field"),f=e.getAttribute("data-filter-operator");var v=e.getAttribute("data-filter-value");const y=e.getAttribute("data-filter-field2"),A=e.getAttribute("data-filter-operator2");var x=e.getAttribute("data-filter-value2");if(0==v.indexOf("{")&&v.indexOf("}")>-1){E=(E=v.replace("{","")).replace("}","");try{v=window[E]}catch(e){app.preloader.hide();var k="[com.thoriumbuilder.dbexpress] Unable to find variable "+E+"] "+e;return thoriumapi.logEvent(2,k),void app.dialog.alert(k)}}if(0==x.indexOf("{")&&x.indexOf("}")>-1){var E;E=(E=x.replace("{","")).replace("}","");try{x=window[E]}catch(e){app.preloader.hide();k="[com.thoriumbuilder.dbexpress] Unable to find variable "+E+"] "+e;return thoriumapi.logEvent(2,k),void app.dialog.alert(k)}}b&&f&&v&&(m.append("field1",b),m.append("operator1",f),m.append("value1",v),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Adding Filter ["+b+f+v+"]")),y&&A&&x&&(m.append("field2",y),m.append("operator2",A),m.append("value2",x),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Adding Filter ["+y+A+x+"]"));1==("1"==e.getAttribute("data-user-data")||!1)&&(m.append("userdata",1),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Adding Filter [user data]"));var w=e.getAttribute("data-maxrows")||0;w>0&&(m.append("offset",s),m.append("maxrows",w));var S=e.getAttribute("data-order-sort")||"asc";m.append("sort",S);var D=e.getAttribute("data-orderby")||null;D&&m.append("orderby",D),c.body=m,fetch(d,c).then((function(t){t.text().then((t=>{var a;thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Got Response from url ["+d+"]");try{a=JSON.parse(t)}catch(e){return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+e.message),app.emit("dbExpressDataLoadError",$(this),e.message),app.preloader.hide(),app.dialog.alert(e.message),void(dbExpressData.allowInfinite=!0)}if(a&&a.code<0||!a){var i="Unable to load repeater with id ["+e.id+"], error "+a.code+": "+a.message;return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+i),app.emit("dbExpressDataLoadError",$(this),i),app.preloader.hide(),app.dialog.alert(i),void(dbExpressData.allowInfinite=!0)}var o=0,l=0,p=a.result;if(p)for(var c in p)p[o].dataindex=o+s,p[o].service=n,o+=1,l+=1;if(p||(p={}),1==e.classList.contains("openstreetmap-api"))return dbExpressMaps.addMarkersToMap(e,p,"osm"),void app.preloader.hide();if(1==e.classList.contains("googlemapAPI"))return dbExpressMaps.addMarkersToMap(e,p,"googlemap"),void app.preloader.hide();if(1==e.classList.contains("dbexpress-virtual-list-content")){if(1==r){if(0==l||l<parseInt(w)){e.setAttribute("data-fetched",!0);const t=document.querySelectorAll(".infinite-scroll-preloader");for(o=0;o<t.length;o++){t[o].style.visibility="hidden"}}const t=e.closest(".page-content");var m=0;t&&(m=t.scrollTop||0),e.setAttribute("data-offset",parseInt(s)+parseInt(w)),u.appendItems(p),u.update(),t&&m>0&&t.scrollTo({top:m,behavior:"smooth"})}else e.setAttribute("data-fetched",!1),u&&app.virtualList.destroy(u),e.style.visibility="visible",e.setAttribute("data-offset",o),dbExpressData.setRepeaterDataContent(e,p),app.emit("dbExpressDataLoadSuccess",$(this),e,p);dbExpressData.allowInfinite=!0}app.preloader.hide()})).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+e),app.emit("dbExpressDataLoadError",$(this),e),app.dialog.alert(e.message)}))})).catch((function(l){if(app.preloader.hide(),1==thoriumapi.isLocal()&&-1!=l.message.toLowerCase().indexOf("network connection"))return thoriumapi.logEvent(1,"[com.thoriumbuilder.dbexpress] - server busy, relaunch service ["+n+"]"),void dbExpressData.getRepeaterData(e,t,r,a,i,o);thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] - service ["+n+"] "+l.message),app.emit("dbExpressDataLoadError",$(this),l),0==app.online||app.dialog.alert(l.message)}))},loadRecord:function(e,t,r){app.preloader.show();var a=new FormData;if("null"==r&&(r=null),a.append("service",t),r)a.append("uid",r);else{var i="No UID parameter found for calling Service "+t;thoriumapi.logEvent(1,"[com.thoriumbuilder.dbexpress] "+i)}a.append("token",auth.currentUser.token);var o={method:"post"};o.body=a;var n=document.querySelector(".page[data-name='"+e.getAttribute("data-name")+"'] .dbexpress-displayer")||null;n&&(n.style.display="none"),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress.data] loading record with uid ["+r+"] from service ["+t+"]");var l=thoriumCorePlugin.httpRoot+kApiRoot+kGetDataApi+"?rnd="+Math.floor(100*Math.random());fetch(l,o).then((function(r){r.text().then((r=>{var a;thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Got Response from url ["+l+"]");try{a=JSON.parse(r)}catch(e){return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+e.message),void app.preloader.hide()}if(a&&a.code<0||!a){app.preloader.hide();var i="Unable to load data for page ["+e.getAttribute("data-name")+"] with service ["+t+"] : invalid result: "+a.message;return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+i),void app.dialog.alert(i)}if(!a.result||0==a.result.length){app.preloader.hide();i="Unable to load data for page ["+e.getAttribute("data-name")+"] with service ["+t+"] : invalid result";return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+i),void app.dialog.alert(i)}var o=a.result[0];o||(o={});const s=document.querySelectorAll(".page[data-name='"+e.getAttribute("data-name")+"'] .dbexpress-displayer");for(var p=0;p<s.length;p++){var u=s[p].getAttribute("data-service")||null;u&&u==t&&dbExpressData.fillDisplayerFromMemoryData(s[p],o)}const d=document.querySelectorAll(".page[data-name='"+e.getAttribute("data-name")+"'] .dbexpress-form[data-from-repeater='true']");for(p=0;p<d.length;p++){var c=d[p].getAttribute("data-service")||null;c&&c==t&&dbExpressData.fillFormFromData(d[p],o)}app.preloader.hide(),n&&(n.style.display="block")})).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] - service ["+t+"]  "+e),app.emit("dbExpressDataLoadError",this,e),app.dialog.alert(e.message)}))})).catch((function(e){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] - service ["+t+"] "+e.message),app.emit("dbExpressDataLoadError",$(this),e),0==app.online?thoriumCorePlugin.showNotification("Internet connection lost"):app.dialog.alert(e.message)}))},onRepeaterLineChange:function(e,t){var r=t.getAttribute("data-index")||null;if(r){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] click/touch on line ["+r+"]");var a=t.getAttribute("data-uid")||null,i=t.getAttribute("data-pk")||null,o=t.closest(".dbexpress-virtual-list-content");if(o){var n=t.closest(".dbexpress-virtual-list");if(n&&app.emit("dbExpressRepeaterLineChange",n,r),app.emit("dbExpressRepeaterLineChange",o,r),1==t.classList.contains("dbexpress-action-button")){var l=t.getAttribute("data-target")||null,s=t.getAttribute("data-transition")||"f7-push",p=t.getAttribute("data-service")||null;e.preventDefault(),(u=app.view)&&u.length>0&&app.view[0].router.navigate("/"+l+"/?rowindex="+r+"&uid="+a+"&pk="+i+"&service="+p+"&parentvlid="+o.id,{animate:!0,transition:s,reloadAll:!1})}else{l=o.getAttribute("data-detail")||null;var u,d=o.getAttribute("data-target-repeater")||null,c=o.getAttribute("data-foreignkey-link")||null;p=o.getAttribute("data-service")||null,s=o.getAttribute("data-transition")||"f7-push";if(l)e.preventDefault(),(u=app.view)&&u.length>0&&app.view[0].router.navigate("/"+l+"/?rowindex="+r+"&uid="+a+"&pk="+i+"&service="+p+"&parentvlid="+o.id,{animate:!0,transition:s,reloadAll:!1});else if(d){var m=document.querySelector(".page-current").getAttribute("data-record-pk")||null,h=document.getElementById(d);if(h&&c)1==("true"==o.getAttribute("data-target-reset-filters")||!1)&&(h.setAttribute("data-filter-field",""),h.setAttribute("data-filter-operator",""),h.setAttribute("data-filter-value",""),h.setAttribute("data-filter-field2",""),h.setAttribute("data-filter-operator2",""),h.setAttribute("data-filter-value2","")),h.setAttribute("data-loaded",!1),dbExpressData.getRepeaterData(h,m,!1,null,c,i)}}}}},calendarInsertDateSync:function(e,t,r,a,i,o){var n=thoriumCorePlugin.httpRoot+kApiRoot+kSetDataApi,l=new FormData;l.append(r,t),l.append("service",e),l.append("token",auth.currentUser.token),a&&a.length>0&&l.append(a,i),app.request({url:n,data:l,method:"POST",crossDomain:!1,contentType:"multipart/form-data",headers:"",timeout:0,async:!1,processData:!0,beforeSend(){app.preloader.show()},error(e,t){app.preloader.hide();var r=(e.responseText+" "+e.statusText).trim();0==r.length&&(r="Unknown Error, maybe due to access control checks ( Access-Control-Allow-Origin). "),thoriumapi.logEvent(2,"[com.thoriumbuilder.core] Form Error: ["+r+"] when submitting data"),erm.length>0?thoriumCorePlugin.showAlert(erm):thoriumCorePlugin.showAlert("An error occured ["+r+"] when submitting data")},success(e,t,r){try{var a=JSON.parse(e)}catch(e){return thoriumapi.logEvent(2,"Error "+e),void app.dialog.alert(e)}return a&&a.code<0?(thoriumapi.logEvent(2,"Error "+a.code+" "+a.message),void app.dialog.alert(a.message)):a?void thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Calendar data Sent with Success"):(thoriumapi.logEvent(2,"Error, invalid result"),void app.dialog.alert("Error, invalid result"))}})},savecalendar:function(e){var t=document.querySelector("#"+e+" .calendar");if(t){app.preloader.show();var r=document.querySelector("#"+e),a=app.calendar.get(t);if(a){var i=r.getAttribute("data-parent-pk"),o=r.getAttribute("data-foreign-key"),n=r.getAttribute("data-service-field"),l=r.getAttribute("data-service"),s=a.value;if(s)for(const[e,t]of Object.entries(s)){var p=new Date(t);if(p){app.preloader.show();var u=p.getTime()/1e3;dbExpressData.calendarInsertDateSync(l,u,n,o,i)}}app.view[0].router.back(),app.preloader.hide()}}},getCalendarData:function(e,t){var r=e.getAttribute("data-service")||null;if(e.setAttribute("data-parent-pk",t),!r)return void thoriumapi.logEvent(1,"[com.thoriumbuilder.dbexpress] Calendar Service not set");var a=e.getAttribute("data-service-field")||null;if(!a)return void thoriumapi.logEvent(1,"[com.thoriumbuilder.dbexpress] Calendar Service Field not set");var i=thoriumCorePlugin.httpRoot+kApiRoot+kGetDataApi+"?rnd="+Math.floor(100*Math.random());thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Get data for Calendar with ID ["+e.id+"] from url ["+i+"]");var o={method:"post"},n=new FormData;if(n.append("service",r),n.append("token",auth.currentUser.token),t&&t.length>0){var l=e.getAttribute("data-foreign-key")||null;l&&(n.append("parentpk",t),n.append("foreignkey",l),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Adding Filter [Parent key "+l+"="+t+"]"))}1==("1"==e.getAttribute("data-user-data")||!1)&&(n.append("userdata",1),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Adding Calendar Filter [user data]")),o.body=n,fetch(i,o).then((function(t){t.text().then((t=>{var o;thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Got Response from url ["+i+"]");try{o=JSON.parse(t)}catch(t){return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+t.message),app.emit("dbExpressDataLoadError",e,t.message),app.preloader.hide(),void app.dialog.alert(t.message)}if(o&&o.code<0||!o){var n="Unable to load repeater with id ["+e.id+"], error "+o.code+": "+o.message;return thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+n),app.emit("dbExpressDataLoadError",e,n),app.preloader.hide(),void app.dialog.alert(n)}var l=0,s=o.result;if(s)for(var p in s){s[l].dataindex=l,s[l].service=r;var u=s[l];l+=1,1;var d=new Date(1e3*u[a]);d=new Date(d.toDateString()),thoriumapi.date.disableDateFromCalendar(e.id,d)}s||(s={}),app.preloader.hide()})).catch((function(t){app.preloader.hide(),thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+t),app.emit("dbExpressDataLoadError",e,t),app.dialog.alert(t.message)}))})).catch((function(a){if(app.preloader.hide(),1==thoriumapi.isLocal()&&-1!=a.message.toLowerCase().indexOf("network connection"))return thoriumapi.logEvent(1,"[com.thoriumbuilder.dbexpress] - server busy, relaunch service ["+r+"]"),void dbExpressData.getCalendarData(e,t);thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] - service ["+r+"] "+a.message),app.emit("dbExpressDataLoadError",e,a),0==app.online||app.dialog.alert(a.message)}))},onPageMounted:function(e){var t,r=e.detail;if(r===page?elt=app.root:(elt=r.$el,t=r.route),elt&&t){var a=t.query.rowindex||null,i=t.query.uid||null;i||(i=t.query.id||null);var o=t.query.pk||null,n=t.query.service||null,l=document.querySelector(".page-next"),s=document.querySelector(".page-current");dbExpressData.applyUserRolePermissions(),a&&i&&n&&o?l&&(l.setAttribute("data-record-uid",i),l.setAttribute("data-record-pk",o),l.setAttribute("data-record-service",n)):(a=-1,s&&(i=s.getAttribute("data-record-uid")||null,o=s.getAttribute("data-record-pk")||null,n=s.getAttribute("data-record-service")||null,l&&(l.setAttribute("data-record-uid",i),l.setAttribute("data-record-pk",o),l.setAttribute("data-record-service",n))));var p=document.querySelector(".page[data-name='"+r.name+"'] .dbexpress-displayer"),u=document.querySelector(".page[data-name='"+r.name+"'] .dbexpress-form[data-from-repeater='true']");if((u||p)&&(u&&(u.style.visibility="hidden"),p&&(p.style.visibility="hidden"),dbExpressData.loadRecord(l,n,i)),n&&o){var d=document.querySelector(".page[data-name='"+r.name+"'] .dbexpress-form *[name='fk_"+n+"']");d&&(d.value=o,d.setAttribute("data-parent-pk",o))}for(var c=document.querySelectorAll(".page[data-name='"+r.name+"'] .dbexpress-virtual-list-content"),m=0;m<c.length;m++){var h=c[m];h.style.visibility="hidden",dbExpressData.getRepeaterData(h,o)}var g=document.querySelectorAll(".page[data-name='"+r.name+"'] .custom-db-calendar");for(m=0;m<g.length;m++){var b=g[m],f=b.querySelector(".calendar");f&&0==auth.currentUser.group?f.classList.add("disabled"):f.classList.remove("disabled"),dbExpressData.getCalendarData(b,o)}if(1==kDbExpressEcommerce&&dbExpressCommerce.initCartController(),"undefined"!=typeof openStreetMapPlugin&&dbExpressMaps.initAllopenStreetMaps(!1),"undefined"!=typeof googleMapPlugin&&dbExpressMaps.initAllGoogleMaps(!0),auth.currentUser.photoURL&&auth.currentUser.photoURL.length>0){var v=auth.getDbAssetsUrlRoot()+auth.currentUser.photoURL+"?rnd="+Math.floor(100*Math.random());$(".dbexpress_avatar").attr("src",v)}}},setRepeaterDataContent:function(e,t){var r,a=e.getAttribute("data-displaymode")||0,i=document.getElementById("template-"+e.id);(r=$("#"+e.id).data("template")||null)&&0!=r.length||(r=a<2?dbExpressData.getRepeaterTemplate(i):i.outerHTML,$("#"+e.id).data("template",r));var o=r;if(r=(r=r.replaceAll("{data-img-root}",auth.getDbAssetsUrlRoot())).replaceAll("{data-asset-root}",auth.getDbAssetsUrlRoot()),a<2)thoriumCorePlugin.renderVirtualListFromData(e,t,r);else if(e.scrollLeft=0,e.innerHTML=o,$("#"+e.id).data("items",t),t.length>0){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Render Repeater for Repeater with ID ["+e.id+"]"),$("#"+e.id).data("items",t);var n,l=0,s=auth.getDbAssetsUrlRoot();for(var p in thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Get horizontal Repeater Rows for Repeater with ID ["+e.id+"]"),t)n=(n=(n=(n=(n=(n=dbExpressData.getCollectionRow("",t[p],r)).replaceAll("templaterow","")).replaceAll("template-"+e.id,"template-"+e.id+"-"+l)).replaceAll("{data-img-root}",s)).replaceAll("{data-asset-root}",s)).replace("url("+s+")","url('./img/defaultimg.png')"),e.innerHTML=e.innerHTML+n,l+=1;e.setAttribute("data-loaded",!0),e.setAttribute("data-count",t.length)}},getRepeaterTemplate:function(e){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Get Template for Repeater with ID ["+e.id+"]");var t=e.outerHTML;e.style.display=null,e.removeAttribute("id"),e.removeAttribute("data-template-height"),e.classList.remove("templaterow");var r=e.outerHTML;return e.outerHTML=t,r},getCollectionRow:function(e,t,r){for(var a in t){var i;if("object"==typeof t[a]&&null!==t[a]){if(!Array.isArray(t[a]))i=e.length>0?e+"."+a:a,r=dbExpressData.getCollectionRow(i,t[a],r)}else if(i=e.length>0?e+"."+a:a){i=i.replaceAll(" ","_");var o=t[a];o||0==o||(o=""),"auth_photourl"==a&&0==o.length&&r.indexOf("{{auth_photourl}}")>=0&&(r=r.replace(auth.getDbAssetsUrlRoot()+"{{auth_photourl}}","./img/defaultavatar.png")),r=(r=r.replaceAll("{{"+i+"}}",o)).replaceAll("{"+i+"}",o)}}return r},parseDataRecursive:function(e,t,r){for(var e in app.dialog.alert("[com.thoriumbuilder.dbexpress] parseDataRecursive"),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Parsing Data "),t){if("object"==typeof t[e]&&null!==t[e])if(Array.isArray(t[e]))r[e.replaceAll(" ","_")]=t[e];else dbExpressData.parseDataRecursive(e,t[e],r);else r[e.replaceAll(" ","_")]=t[e]}return r},fillDisplayerFromMemoryData:function(e,t){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Set Content for Displayer with ID ["+e.id+"]"),$("#"+e.id+" .dbexpress-field").each((function(e){var r=e.tagName.toLowerCase(),i=e.className.toLowerCase(),o=e.getAttribute("data-dbexpress-field")||null,n=e.getAttribute("data-dbexpress-type")||null;if("route"==n){var l=e.getAttribute("data-latitude")||null,s=e.getAttribute("data-longitude")||null,p=e.getAttribute("onclick")||null;if(l&&s&&p){var u=t[l],d=t[s];u&&d?(p=(p=p.replaceAll("{{"+l+"}}",u)).replaceAll("{{"+s+"}}",d),e.setAttribute("onclick",p)):e.setAttribute("onclick","")}}else if(n&&"map"==n){var c=e.getAttribute("data-latitude")||null,m=e.getAttribute("data-longitude")||null;if(c&&m){u=t[c],d=t[m],d=t[m];dbExpressMaps.initDisplayerMap(e,u,d)}else e.style.display="none"}else if(o){dataValue=t[o];var h=e.getAttribute("data-date-type")||null;if(e.getAttribute("data-function")||null||h)templateHtml=thoriumCorePlugin.applyFormulaToField(e,e.innerHTML,o,dataValue),e.innerHTML=templateHtml;else if(n&&"decimal"==n)templateHtml=thoriumCorePlugin.applyFormulaToField(e,e.innerHTML,o,dataValue),e.innerHTML=templateHtml;else if(n&&"rating"==n){const t='<i class="fa f7-icons s-3" data-icon="star_fill">star_fill</i>';dataValue||(dataValue=0);var g=parseInt(dataValue)||0,b="";for(a=0;a<g;a++)b+=t;e.innerHTML=e.innerHTML.replaceAll("{{"+o+"}}",b)}else if(n&&"video"==n){var f=e.querySelector("video");f&&(dataValue&&dataValue.length>0?f.setAttribute("src",auth.getDbAssetsUrlRoot()+dataValue):(e.style.display="none",f.setAttribute("src","")))}else if(n&&"audio"==n){var v=e.querySelector("audio");v&&(dataValue&&dataValue.length>0?v.setAttribute("src",auth.getDbAssetsUrlRoot()+dataValue):(e.style.display="none",v.setAttribute("src","")))}else if(n&&"picture"==n){const r=e.querySelector(".dbexpress-image-content");if(r)if(dataValue){var y=e.getAttribute("data-httproot")||"";"createdby_photourl"==o?r.style.backgroundImage="url('"+auth.getDbAssetsUrlRoot()+dataValue+"')":-1!=dataValue.toLowerCase().indexOf("http://")||-1!=dataValue.toLowerCase().indexOf("https://")?r.style.backgroundImage="url('"+dataValue+"')":(t.uid&&r.setAttribute("data-img-name",dataValue),r.style.backgroundImage="url('"+auth.getDbAssetsUrlRoot()+dataValue+"?rnd="+Math.floor(100*Math.random())+"')")}else e.style.display="none";else e.setAttribute("src",auth.getDbAssetsUrlRoot()+dataValue)}else if(["embed-responsive-item"].indexOf(i)>-1&&"audio"!=r&&"video"!=r){y=e.getAttribute("data-httproot")||"";dataValue?e.style.backgroundImage="url('"+y+dataValue+"')":e.closest(".embed-responsive").style.display="none"}else if(dataValue||0==dataValue){var A=e.innerHTML,x=e.getAttribute("data-inner-template")||null;if(x?A=x:e.setAttribute("data-inner-template",A),1==i.includes("dbexpress-number")&&parseFloat(dataValue)>0){var k=parseInt(e.getAttribute("data-decimal"))||0,E=parseFloat(dataValue);dataValue=E.toFixed(k)}A&&o&&(e.innerHTML=A.replaceAll("{{"+o+"}}",dataValue),e.style.display="block"),"a"==r&&(A=e.getAttribute("href"))&&(A=A.replaceAll("{{"+o+"}}",dataValue),e.setAttribute("href",A))}else e.style.display="none"}}));for(var r=document.querySelectorAll("#"+e.id+" .dbexpress-action-button"),a=0;a<r.length;a++)for(var i=r[a],o=0;o<i.attributes.length;o++){var n=i.attributes[o];for(const e in t)n.value=n.value.replaceAll("{{"+e+"}}",t[e]);if("data-service"==n.name){var l=e.getAttribute("data-service")||null;l&&(n.value=l)}}e.setAttribute("data-loaded",!0),e.style.visibility="visible"},getDateFromTimeStamp:function(e){var t=new Date(1e3*e);return isNaN(t.getTime())?e:new Intl.DateTimeFormat("en-EN",{hour12:kHours12,hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit",year:"numeric",literal:"/"}).format(t).toLowerCase()},collectionrepeaterLineClick:function(e,t){var r=t.attr("data-index")||null,a=t.attr("data-uid")||null;if(r){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Detect Click/Touch on Collection item line ["+r+"]");var i=t.parents(".dbexpress-virtual-list-content");if(i){var o=i.data("items"),n=i.attr("data-detail")||null,l=o[r],s=app.view;s&&s.length>0&&s[0].router.navigate("/"+n+"/?rowindex="+r+"&data="+encodeURIComponent(JSON.stringify(l))+"&key="+a)}}},repeaterFilterHandler:function(e){var t=e.getAttribute("data-filter-virtuallist")||null,r=document.getElementById(t);if(r){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Set New Filter for Repeater with ID ["+t+"]"),r.setAttribute("data-loaded",!1),r.setAttribute("data-count",0),r.setAttribute("data-filter-field",e.getAttribute("data-filter-field")||""),r.setAttribute("data-filter-operator",e.getAttribute("data-filter-operator")||""),r.setAttribute("data-filter-value",e.getAttribute("data-filter-value")||""),r.setAttribute("data-filter-field2",e.getAttribute("data-filter-field2")||""),r.setAttribute("data-filter-operator2",e.getAttribute("data-filter-operator2")||""),r.setAttribute("data-filter-value2",e.getAttribute("data-filter-value2")||""),r.setAttribute("data-user-data",e.getAttribute("data-user-data")||!1),r.setAttribute("data-orderby",e.getAttribute("data-orderby")||""),r.setAttribute("data-order-sort",e.getAttribute("data-order-sort")||""),r.removeAttribute("data-parent-fk"),r.removeAttribute("data-parent-fk-value");var a=r.closest(".page-content");a&&(a.scrollTop=0),dbExpressData.getRepeaterData(r)}else{var i="An error occured, the Json Repeater is not initialized";thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress] "+i),app.dialog.alert(i)}},repeaterLineButtonClick:function(e,t){app.dialog.alert("[com.thoriumbuilder.dbexpress] repeaterLineButtonClick");var r=t.attr("data-index")||null,a=t.attr("data-uid")||null,i=t.attr("data-target")||null,o=t.attr("data-transition")||null;if(r){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Detect Click/Touch on Line ["+r+"]");var n=t.parents(".json-virtual-list-content");if(n&&n.length>0){var l=app.virtualList.get("#"+n[0].id);if(l){var s=l.items[r],p=app.view,u=t.closest(".virtual-list")||null,d=null;u&&(d=u[0].id),p&&p.length>0&&(app.emit("VirtualListLineClick",t,r,s,i),p[0].router.navigate("/"+i+"/?rowindex="+r+"&data="+encodeURIComponent(JSON.stringify(s))+"&key="+a+"&parentvlid="+d,{animate:!0,transition:o,reloadAll:!1}))}}}},getFlatFormData:function(e,t,r){for(var a in app.dialog.alert("[com.thoriumbuilder.dbexpress] getFlatFormData"),t){if("object"==typeof t[a]&&null!==t[a])if(Array.isArray(t[a]))r[a.replaceAll(" ","_")]=t[a];else dbExpressData.getFlatFormData(e+"."+a,t[a],r);else r[e+"."+a.replaceAll(" ","_")]=t[a]}return r},convertFormData:function(e,t,r,a){var i=e.classList.contains("shadow-text");if("checkbox"==e.type)"true"===r||!0===r||"1"===r||1===r||"on"===r?(a[t]="on",e.setAttribute("checked","checked")):(a[t]="off",e.removeAttribute("checked"));else if("select-one"==e.type||"select"==e.tagName.toLowerCase){$("#"+e.id).attr("data-value",r);var o=$("#"+e.id).closest(".smart-select");if(o&&o.length>0){var n=app.smartSelect.get(o);n&&n.setValue(r)}else{$("#"+e.id).val(r),0==$("#"+e.id).html().trim().length&&$("#"+e.id).html('<option value="'+r+'">'+r+"</option>")}a[t]=r}else if("image"==e.type){if($("#"+e.id+"-fileinput-filename").css("visibility","hidden"),r&&r.length>0){var l=auth.getDbAssetsUrlRoot()+r+"?rnd="+Math.floor(100*Math.random());$("#"+e.id).data("data-blob",""),$("#"+e.id).css("background-image","url("+l+")"),$("#"+e.id+"-fileinput-filename span").text(l),$("#"+e.id+"-remove").show()}}else if("range"==e.type){a[t]=r;var s=app.range.get(e.parentElement);s?s.setValue(r):(s=app.range.create(e.parentElement)).setValue(r)}else if(1==i){a[t]=r;var p=e.id.replaceAll("-shadow",""),u=app.textEditor.get("#"+p);u&&u.setValue(r)}else if("text"==e.type){e.value=r;var d=e.getAttribute("data-date-type");if(d&&("datetime-local"==d||"date"==d))if(r&&0!=r){e.setAttribute("data-timestamp",r);var c=thoriumCorePlugin.getDateTimeFromTimeStamp(r,d);e.value=c}else e.value=""}else if("textarea"==e.type)e.value=r;else if("radio"==e.type)for(var m=e.closest("ul"),h=e.getAttribute("name"),g=m.querySelectorAll("input[name='"+h+"']"),b=0;b<g.length;b++){const e=g[b];e.value==r?e.setAttribute("checked","checked"):e.removeAttribute("checked")}else if("file"==e.type){var f=e.getAttribute("data-fileinput-ref"),v=$("#"+f);v&&v.length>0&&($("#"+f+"-fileinput-filename").show(),$("#"+f+"-fileinput-filename").css("visibility","visible"),$("#"+f+"-fileinput-filename span").text(r),$("#"+f+"-fileinput-filename i").show(),$("#"+f+"-fileinput-link").show(),$("#"+f+"-fileinput-link span").html('<a class="external" target="_blank" rel="noopener" data-rel="external" target="_blank" href="'+r+'">See attached file</a>'),r&&r.length>0?$("#"+f+"-remove").show():$("#"+f+"-fileinput-filename").css("visibility","hidden")),a[t]=r}else a[t]=r,e.value=r;return a},fillFormFromData:function(e,t,r,a,i){if(t&&!0!==e.getAttribute("data-loaded")){var o={};for(var n in t){if("object"==typeof t[n]&&null!==t[n])o=dbExpressData.getFlatFormData(n,t[n],o);else o[n.replaceAll(" ","_")]=t[n]}thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Set dbExpress Form Data for form with ID ["+e.id+"]");for(let[e,r]of Object.entries(o)){var l=e;!0===["name","id","description","this","title","submit"].includes(l)&&(l+="_alias");var s=document.getElementsByName(l)[0];s&&dbExpressData.convertFormData(s,e,r,t)}app.form.fillFromData("#"+e.id,{}),e.setAttribute("data-loaded",!0),e.setAttribute("data-parent-key",r),e.setAttribute("data-virtuallist-id",a),e.setAttribute("data-index",i),e.style.visibility="visible"}}},dbExpressCommerce={name:"Thorium Builder dbExpress eCommerce Plugin",bundleid:"com.thoriumbuilder.dbexpress.ecommerce",version:"3.0.0",allowInfinite:!0,shoppingCartPopup:null,addItemToCart:function(e){app.preloader.show();var t=e.getAttribute("data-uid"),r=e.getAttribute("data-pk"),a=e.getAttribute("data-service"),i=e.getAttribute("data-qty")||1,o=e.getAttribute("data-field-name")||"",n=e.getAttribute("data-field-price")||0,l=e.getAttribute("data-field-img")||"",s=e.getAttribute("data-field-desc")||"",p=new FormData;p.append("token",auth.currentUser.token),p.append("service",a),p.append("uid",t),p.append("parent_pk",r),p.append("qty",i),p.append("cart_unit_price",n),p.append("cart_name",o),p.append("cart_photo",l),p.append("cart_desc",s);var u=thoriumCorePlugin.httpRoot+kApiRoot+kSetShoppingCartApi;fetch(u,{method:"post",body:p,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(t){if(t&&t.code<0)app.preloader.hide(),app.dialog.alert(t.message);else if(t&&0==t.code){var r=t.count||"";$(".shoppingcartcounter").text(r);const a=e.getAttribute("data-cart-message")||null;a&&a.length>0&&thoriumCorePlugin.showToast(a,!1,"bottom",1e3)}app.sheet.close(".sheet-addtocart"),app.preloader.hide()})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},addToCartHandler:function(e){if(1==("true"==e.getAttribute("data-qty-selector")||!1)){var t=document.querySelector(".button-cart");t.setAttribute("data-uid",e.getAttribute("data-uid")),t.setAttribute("data-pk",e.getAttribute("data-pk")),t.setAttribute("data-index",e.getAttribute("data-index")),t.setAttribute("data-service",e.getAttribute("data-service")),t.setAttribute("data-field-name",e.getAttribute("data-field-name")),t.setAttribute("data-field-price",e.getAttribute("data-field-price")),t.setAttribute("data-field-img",e.getAttribute("data-field-img")),t.setAttribute("data-field-desc",e.getAttribute("data-field-desc")),t.setAttribute("data-cart-message",e.getAttribute("data-cart-message")),t.setAttribute("data-qty","1"),app.sheet.create({el:".sheet-addtocart",swipeToClose:!1,backdrop:!0}).open(!0);var r=app.stepper.get("#stepper-addtocart");r&&r.destroy(),r=app.stepper.create({el:"#stepper-addtocart",step:1,min:1,max:1e3,value:1,on:{change:function(e,r){t.setAttribute("data-qty",r)}}})}else dbExpressCommerce.addItemToCart(e)},getCustomerInformation:function(e){if(1==("true"==document.getElementById("shoppingcartform").getAttribute("data-loaded")))return app.tab.show("#shoppingCartTab2",!0),void $("#shoppingcartpopup-content").scrollTop(0,0);app.preloader.show();var t=new FormData,r=auth.getToken();r&&t.append("token",r),t.append("email",auth.currentUser.email);var a=thoriumCorePlugin.httpRoot+kApiRoot+kGetProfileApi;fetch(a,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(1==thoriumapi.checkResult(e)){$('#shoppingcartform input[name="shoppingcart-displayname"]').val(e.displayName),$('#shoppingcartform input[name="shoppingcart-email"]').val(e.email),$('#shoppingcartform input[name="shoppingcart-phonenumber"]').val(e.phoneNumber),$('#shoppingcartform textarea[name="shoppingcart-address"]').val(e.address),$('#shoppingcartform input[name="shoppingcart-zip"]').val(e.zip),$('#shoppingcartform input[name="shoppingcart-city"]').val(e.city),$('#shoppingcartform input[name="shoppingcart-country"]').val(e.country),$('#shoppingcartform textarea[name="shoppingcart-notes"]').val(e.notes);const t=document.querySelector('input[name="deliverymodeselect"]:checked');if(t){const e="true"==t.getAttribute("data-no-address")||!1,r=document.querySelector(".addressblock");1!=e?(r.classList.remove("hidden"),document.querySelector("#shoppingcart-address").setAttribute("required","required"),document.querySelector("#shoppingcart-zip").setAttribute("required","required"),document.querySelector("#shoppingcart-city").setAttribute("required","required")):(r.classList.add("hidden"),document.querySelector("#shoppingcart-address").removeAttribute("required"),document.querySelector("#shoppingcart-zip").removeAttribute("required"),document.querySelector("#shoppingcart-city").removeAttribute("required"))}app.preloader.hide(),app.tab.show("#shoppingCartTab2",!0),$("#shoppingcartpopup-content").scrollTop(0,0)}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},setCustomerInformation:function(e){app.preloader.show();var t=new FormData,r=auth.getToken();r&&t.append("token",r),t.append("token",r),t.append("uid",auth.currentUser.uid);for(var a,i=document.getElementById("shoppingcartform").elements,o=0;a=i[o++];){var n=a.name.replace("shoppingcart-","");t.append(n,a.value)}var l=thoriumCorePlugin.httpRoot+kApiRoot+kSetProfileApi;fetch(l,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){1==thoriumapi.checkResult(e)&&(app.preloader.hide(),app.tab.show("#shoppingCartTab3",!0),$("#shoppingcartpopup-content").scrollTop(0,0))})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},changeCartQuantity:function(e,t){var r=e.el.getAttribute("data-line-pk")||null;if(r){app.preloader.show();var a=new FormData;a.append("token",auth.currentUser.token),a.append("pk",r),a.append("qty",t);var i=thoriumCorePlugin.httpRoot+kApiRoot+kSetShoppingCartQtyApi;fetch(i,{method:"post",body:a,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(1==thoriumapi.checkResult(e)){for(var t=e.totalquantity,a=document.querySelectorAll(".shoppingcartcounter"),i=0;i<a.length;i++){a[i].innerText=t}var o=e.totalcart,n=e.totalline,l=document.querySelectorAll(".shoppingcarttotal");for(i=0;i<l.length;i++){var s=l[i];1==kCurrencyLeftSide?s.innerText=kCurrencySymbol+Number.parseFloat(o).toFixed(2):s.innerText=Number.parseFloat(o).toFixed(2)+kCurrencySymbol}var p=document.querySelector('.shoppingcart-line-total[data-line-pk="'+r+'"]');1==kCurrencyLeftSide?p.innerText=kCurrencySymbol+Number.parseFloat(n).toFixed(2):p.innerText=Number.parseFloat(n).toFixed(2)+kCurrencySymbol,app.preloader.hide()}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))}},openCart:function(e){thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Loading Shopping Cart"),app.preloader.show();var t=new FormData;t.append("token",auth.currentUser.token);var r=thoriumCorePlugin.httpRoot+kApiRoot+kGetShoppingCartApi;fetch(r,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(t){if(1==thoriumapi.checkResult(t)){if(!t.result){app.preloader.hide();var r=e.getAttribute("data-message")||null;return void(r&&thoriumCorePlugin.showNotification(r))}thoriumapi.logEvent(0,"[com.thoriumbuilder.ecommerce] Shopping Cart Firebase Record Loaded");var a=t.result,i="",o=$(".shoppingcart-template").html();for(var n in thoriumapi.logEvent(0,"[com.thoriumbuilder.ecommerce] Loading Shopping Cart Item Lines"),a){var l=a[n],s=o;for(var p in l){s=s.replaceAll("{{title}}",l.cart_name),s=(s=(s=(s=(s=(s=1==kCurrencyLeftSide?(s=s.replaceAll("{{price}}",kCurrencySymbol+Number.parseFloat(l.cart_unit_price).toFixed(2))).replaceAll("{{total}}",kCurrencySymbol+Number.parseFloat(l.cart_total_price).toFixed(2)):(s=s.replaceAll("{{price}}",Number.parseFloat(l.cart_unit_price).toFixed(2)+kCurrencySymbol)).replaceAll("{{total}}",Number.parseFloat(l.cart_total_price).toFixed(2)+kCurrencySymbol)).replaceAll("{{pk}}",l.pk)).replaceAll("{{qty}}",l.qty)).replaceAll("{{parent_pk}}",l.parent_pk)).replaceAll("{{uid}}",l.uid)).replaceAll("{{cart_desc}}",l.cart_desc);var u="db/dbassets/"+l.cart_photo+"?rnd="+Math.floor(100*Math.random());s=s.replaceAll("{{image}}","background-image:url('"+u+"');")}i+=s}$("#shoppingcartcontents").html(i),app.tab.show("#shoppingCartTab1",!0),dbExpressCommerce.shoppingCartPopup=app.popup.create({el:".shoppingcartpopup",swipeToClose:!1}),dbExpressCommerce.shoppingCartPopup.open(!0),1==kCurrencyLeftSide?$(".shoppingcarttotal").text(kCurrencySymbol+Number.parseFloat(t.price).toFixed(2)):$(".shoppingcarttotal").text(Number.parseFloat(t.price).toFixed(2)+kCurrencySymbol),0==parseFloat(t.qty)?$("#shoppingcartbutton1").addClass("disabled"):$("#shoppingcartbutton1").removeClass("disabled");const h=document.querySelectorAll(".stepper-shoppingcart");for(var d=0;d<h.length;d++){const e=h[d],t=parseInt(e.getAttribute("data-value"))||0;app.stepper.create({el:e,step:1,min:0,max:100,value:t,on:{change:function(e,t){dbExpressCommerce.changeCartQuantity(e,t)}}})}if(!document.querySelector('input[name="deliverymodeselect"]:checked')){const e=document.querySelector("#deliverymodeselect1");if(e){e.checked=!0;var c,m=e.value||0;c=1==kCurrencyLeftSide?kCurrencySymbol+m:m+kCurrencySymbol,document.querySelector(".shoppingcartdeliveryamount").innerText=c}}app.preloader.hide()}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},initCartController:function(){var e=$(".shoppingcartcounter");if($(".shoppingcartcounter").text("..."),0!=e.length){var t=new FormData;t.append("token",auth.currentUser.token);var r=thoriumCorePlugin.httpRoot+kApiRoot+kGetShoppingCartApi;fetch(r,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(1==thoriumapi.checkResult(e)){var t=e.qty||"0";$(".shoppingcartcounter").text(t),$(".shoppingcartcounter").show()}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))}},processOrderPayment:function(e){},convertCartToOrder:function(e){app.preloader.show();var t=new FormData,r=auth.getToken();r&&t.append("token",r),t.append("token",r),t.append("uid",auth.currentUser.uid);var a=document.querySelector("#orderprocess-collectdate");if(!a||!a.value)return app.preloader.hide(),void a.focus();var i=a.getAttribute("data-timestamp");t.append("collectdate",i);const o=document.querySelector('input[name="deliverymodeselect"]:checked');if(o){const e=o.value||0,r=o.getAttribute("data-label")||"Unknown";t.append("deliverymode",r),t.append("deliveryfees",e)}var n=document.querySelector("#orderprocess-collecttime");if(!n||!n.value)return app.preloader.hide(),void n.focus();t.append("collecttime",n.value);var l=document.querySelector("#orderprocess-notes");l&&t.append("notes",l.value);var s=thoriumCorePlugin.httpRoot+kApiRoot+kSetOrderApi;fetch(s,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){if(1==thoriumapi.checkResult(e)&&(app.preloader.hide(),document.querySelector(".lastordernumber").innerText=e.uid,app.tab.show("#shoppingCartTab5",!0),$("#shoppingcartpopup-content").scrollTop(0,0),document.getElementById("form-orderprocess").reset(),$(".shoppingcartcounter").text("0"),"object"==typeof nodeQrcode)){var t=document.querySelector(".qrbox");if(t){t.style.display="block";var r=document.getElementById("orderqrcode");nodeQrcode.drawQR(r,e.uid)}}})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))},paymentCallback:function(e){app.tab.show("#shoppingCartTab4",!0)},clearShoppingCart:function(e){app.preloader.show();var t=new FormData;t.append("token",auth.currentUser.token);var r=thoriumCorePlugin.httpRoot+kApiRoot+kClearShoppingCartApi;fetch(r,{method:"post",body:t,contentType:"multipart/form-data"}).then(thoriumapi.status).then(thoriumapi.json).then((function(e){1==thoriumapi.checkResult(e)&&(app.preloader.hide(),$(".shoppingcartcounter").text("0"),dbExpressCommerce.shoppingCartPopup&&dbExpressCommerce.shoppingCartPopup.close())})).catch((function(e){thoriumapi.logEvent(2,"[com.thoriumbuilder.dbexpress.data] Request failed "+e),app.preloader.hide(),app.dialog.alert(e.message)}))}};$(document).on("click",".shoppingcartcontroller",(function(e){e.preventDefault(),dbExpressCommerce.openCart(this)})),$(document).on("click",".shoppingcart-clear",(function(e){e.preventDefault(),app.dialog.confirm("Clear?",(function(){dbExpressCommerce.clearShoppingCart(this)}))})),$(document).on("click",".deliverymodeselect",(function(e){var t=document.querySelector('input[name="deliverymodeselect"]:checked');if(t){var r,a=t.value||0;t.getAttribute("data-label");r=1==kCurrencyLeftSide?kCurrencySymbol+a:a+kCurrencySymbol,document.querySelector(".shoppingcartdeliveryamount").innerText=r}})),$(document).on("click","a.dbexpress-search-filter",(function(e){e.preventDefault(),dbExpressData.repeaterFilterHandler(this)})),$(document).on("click","a.btn-json-page",(function(e){e.preventDefault(),dbExpressData.repeaterLineButtonClick(e,$(this))})),$(document).on("click",".button-cart",(function(e){e.preventDefault(),dbExpressCommerce.addItemToCart(this)})),$(document).on("click","#shoppingcartbutton1",(function(e){e.preventDefault(),app.preloader.show(),setTimeout((function(){dbExpressCommerce.getCustomerInformation(this)}),1e3)})),$(document).on("click","#shoppingcartbutton2",(function(e){e.preventDefault(),app.tab.show("#shoppingCartTab1",!0)})),$(document).on("click","#shoppingcartbutton3",(function(e){e.preventDefault(),1==document.getElementById("shoppingcartform").checkValidity()?dbExpressCommerce.setCustomerInformation(this):thoriumapi.logEvent(1,"[com.thoriumbuilder.ecommerce] Missing mandatory fields")})),$(document).on("click","#shoppingcartbackbutton3",(function(e){e.preventDefault(),app.tab.show("#shoppingCartTab1",!0)})),$(document).on("click","#shoppingcartbackbutton4",(function(e){e.preventDefault(),app.tab.show("#shoppingCartTab2",!0)})),$(document).on("click",".saveorderbtn",(function(e){e.preventDefault(),app.preloader.show(),dbExpressCommerce.convertCartToOrder(),dbExpressCommerce.shoppingCartPopup})),$(document).on("click","#shoppingcartbuttonfinish",(function(e){e.preventDefault(),dbExpressCommerce.shoppingCartPopup&&dbExpressCommerce.shoppingCartPopup.close()})),$(document).on("click",'.dbexpress-action-button[data-action="cart"]',(function(e){e.preventDefault(),e.stopImmediatePropagation(),auth.currentUser&&1!=auth.currentUser.isAnonymous?dbExpressCommerce.addToCartHandler(this):auth.handleAvatarPopup(e,this)})),$(document).on("click",'.dbexpress-action-button[data-action="like"]',(function(e){e.preventDefault(),e.stopImmediatePropagation(),app.dialog.alert("Like/Unlike")})),$(document).on("search",".search-repeater",(function(e){})),$(document).on("click",".input-clear-button",(function(e){})),$(document).on("submit",".dbexpress-signin-form",(function(e){e.preventDefault;app.preloader.show(),auth.signInFormPost(this)})),$(document).on("submit",".dbexpress-resetpassword-form",(function(e){e.preventDefault;var t=this;0!=app.input.validateInputs(t)?(app.preloader.show(),auth.resetPasswordSubmitPost(t)):thoriumapi.logEvent(0,"[com.thoriumbuilder.core] Missing Mandatory fields for Form with id ["+t.id+"]")})),$(document).on("submit",".dbexpress-register-form",(function(e){e.preventDefault;var t=$("#dbexpress-register-password").val();t==$("#dbexpress-register-password-verification").val()?t.length<6?app.dialog.alert("Password too Short (6 characters min)"):0!=app.toggle.create({el:".dbexpress-register-gdpr"}).checked?(app.preloader.show(),auth.registerFormPost()):app.dialog.alert("You must accept the Privacy Policy"):app.dialog.alert("Password does not match")})),$(document).on("click",".dbexpress_avatar",(function(e){auth.handleAvatarPopup(e,this)})),$(document).on("click",".firebase-user-logout",(function(e){e.preventDefault,app.dialog.confirm("Logout?",(function(){auth.logout()}))})),$(document).on("click",".dbexpress-profile-submit",(function(e){e.preventDefault,app.preloader.show(),auth.saveProfile()})),$("select").on("change",(function(){$(".dbexpress-profile-flag").css("background-image","url("+thoriumCorePlugin.httpRoot+kApiRoot+"flags/4x3/"+this.value.toLowerCase()+".svg)")})),$(document).on("click",".signinlink",(function(e){e.preventDefault,auth.showSigninPopup(e)})),$(document).on("click",".termsofuse",(function(e){e.preventDefault,auth.showTermsPopup(e)})),$(document).on("click",".privacypolicy",(function(e){e.preventDefault,auth.showPrivacyPopup(e)})),$(document).on("click",".registerlink",(function(e){e.preventDefault,auth.showRegisterPopup(e)})),$(document).on("click",".reloadlink",(function(e){e.preventDefault,location.reload()})),$(document).on("click",".profilelink",(function(e){e.preventDefault,auth.loadProfileScreen()})),$(document).on("click",".resetpasswwordlink",(function(e){e.preventDefault,auth.showResetPasswordScreen()})),$(document).on("search",".dbexpress-searchbar",(function(e){e.preventDefault,dbExpressData.executeRepeaterFullText(e.target)})),$(document).on("submit",".form",(function(e){dbExpressData.submitForm(e,$(this))})),$(document).on("click",".calendar-submit-button",(function(e){e.preventDefault();const t=this.getAttribute("data-calendar")||null;t&&t.length>0&&(0==auth.currentUser.group?(auth.showSigninPopup(),app.view[0].router.back()):dbExpressData.savecalendar(t))})),$(document).on("click",".dbwebshare",(function(e){e.preventDefault();var t=this.getAttribute("data-url")||null,r=this.getAttribute("data-share-text")||null;if(t&&r&&null!=navigator.share)try{navigator.share({title:r,url:t})}catch(e){app.dialog.error("Share failed:",e.message)}})),$(document).on("click",'.dbexpress-action-button[data-action="detail"]',(function(e){if(e.preventDefault(),e.stopImmediatePropagation(),this.closest(".dbexpress-virtual-list")||null)dbExpressData.onRepeaterLineChange(e,this);else if(this.closest(".dbexpress-displayer")||null){var t=this.getAttribute("data-uid")||null,r=this.getAttribute("data-pk")||null,a=this.getAttribute("data-target")||null,i=this.getAttribute("data-service")||null,o=this.getAttribute("data-transition")||"f7-push";if(a){e.preventDefault();var n=app.view;n&&n.length>0&&app.view[0].router.navigate("/"+a+"/?rowindex=0&uid="+t+"&pk="+r+"&service="+i,{animate:!0,transition:o,reloadAll:!1})}}})),$(document).on("click",'.dbexpress-action-button[data-action="delete"]',(function(e){e.preventDefault(),e.stopImmediatePropagation(),dbExpressData.handleDelete(this)})),$(document).on("click",".item-dbexpress",(function(e){e.preventDefault(),dbExpressData.onRepeaterLineChange(e,this)})),$(document).on("infinite",(function(e){if(1==dbExpressData.allowInfinite){var t=e.target;const o=t.querySelectorAll('.virtual-list[data-infinite="true"]');for(var r=0;r<o.length;r++){const e=o[r];if("true"!=(e.getAttribute("data-fetched")||null)){const r=t.querySelector(".infinite-scroll-preloader");r&&(r.style.display="block",r.style.visibility="visible"),thoriumapi.logEvent(0,"[com.thoriumbuilder.dbexpress] Loading Additional Data"),dbExpressData.allowInfinite=!1;var a=e.getAttribute("data-parent-pk")||null,i=e.getAttribute("data-search")||null;setTimeout((function(){dbExpressData.getRepeaterData(e,a,!0,i)}),500)}}}})),$(document).on("page:mounted",(function(e){e.preventDefault,dbExpressData.onPageMounted(e)})),app.on("onAuthStateChanged",(function(e){e&&(dbExpressData.onAuthStateChanged(),1!=e.isAnonymous&&setTimeout((function(){auth.getCountryList(),1==kDbExpressEcommerce&&dbExpressCommerce.initCartController()}),500))})),document.addEventListener("deviceready",auth.initialize),document.addEventListener("DOMContentLoaded",auth.initialize);