/*!
 * Thorium JSON API functions for framework7 projects
 * Version 3.1.4 september 2021
 * framework7 v6.x (https://framework7.io) MIT Licensed
 * Thorium builder 3.1.4Â© Copyright 2018-2021 Nymphide Lab, All Rights Reserved.
*/
var jsonApiPlugin={name:"Thorium Builder JSON API Plugin",bundleid:"com.thoriumbuilder.jsonapi",version:"2.0.0",currentRepeaterId:null,currentDisplayerId:null,parseDataRecursive:function(e,t,i){for(var e in thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Parsing Data "),t){if("object"==typeof t[e]&&null!==t[e])if(Array.isArray(t[e]))i[e.replaceAll(" ","_")]=t[e];else jsonApiPlugin.parseDataRecursive(e,t[e],i);else i[e.replaceAll(" ","_")]=t[e]}return i},setDisplayerDataContent:function(e,t){$("#"+e.id+" [data-json-value]").each((function(a){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Set Content for Displayer with ID ["+e.id+"]");var r=a.tagName.toLowerCase(),n=a.className.toLowerCase(),o=a.getAttribute("data-json-value");const l=o.split(".");var u="";if(l.length>1){var s=t;for(i=0;i<l.length;i++)s=s[l[i]];u=s}else u=t[o];if(["embed-responsive-item"].indexOf(n)>-1&&"audio"!=r&&"video"!=r){var p=a.getAttribute("data-httproot")||"";u?a.style.backgroundImage="url('"+p+u+"')":a.closest(".embed-responsive").style.display="none"}else if(["source"].indexOf(r)>-1||"audio"==r||"video"==r){p=a.getAttribute("data-httproot")||"";u?a.setAttribute("src",p+u):a.style.display="none"}else if("img"==r)if(u){p=a.getAttribute("data-httproot")||"";a.setAttribute("src",p+u)}else a.setAttribute("src","img/defaultimg.png");else if(u){var d=a.innerHTML;d&&o&&(a.innerHTML=d.replaceAll("{"+o+"}",u)),"a"==r&&(d=a.getAttribute("href"))&&(d=d.replaceAll("{"+o+"}",u),a.setAttribute("href",d))}else a.style.display="none"})),e.setAttribute("data-loaded",!0),$("#"+e.id).show()},getRepeaterTemplate:function(e){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Get Template for Repeater with ID ["+e.id+"]");var t=e.outerHTML;e.style.display=null,$("#"+e.id+" .json-field p, .json-field .text-link").each((function(e){var t=e.getAttribute("data-json-value")||"",i=e.tagName.toLowerCase(),a=e.innerHTML;a&&t&&(e.innerHTML=a.replaceAll("{"+t+"}","{{"+t+"}}")),"a"==i&&(a=e.getAttribute("href"))&&t&&(a=a.replaceAll("{"+t+"}","{{"+t+"}}"),e.setAttribute("href",a))})),$("#"+e.id+" .json-field img,video,source").each((function(e){var t=e.getAttribute("data-json-value")||"",i=e.getAttribute("data-httproot")||"";e.setAttribute("src",i+"{{"+t+"}}")})),$("#"+e.id+" .json-field .embed-responsive-item").each((function(e){var t=e.getAttribute("data-json-value")||"",i=e.getAttribute("data-httproot")||"";e.setAttribute("style","background-image:url('"+i+"{{"+t+"}}') , url('img/defaultimg.png')")})),e.removeAttribute("id"),e.removeAttribute("data-template-height"),e.classList.remove("templaterow");var i=e.outerHTML;return e.outerHTML=t,i},getCollectionRow:function(e,t,i){for(var a in thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Get Collection Rows"),t){var r;if("object"==typeof t[a]&&null!==t[a]){if(!Array.isArray(t[a]))r=e.length>0?e+"."+a:a,i=jsonApiPlugin.getCollectionRow(r,t[a],i)}else if(r=e.length>0?e+"."+a:a){r=r.replaceAll(" ","_");var n=t[a];n||0==n||(n=""),i=(i=i.replaceAll("{{"+r+"}}",n)).replaceAll("{"+r+"}",n)}}return i},setRepeaterDataContent:function(e,t){var i,a=e.getAttribute("data-displaymode")||0,r=document.getElementById("template-"+e.id);if(!(r||(i=$("#"+e.id).data("template"))&&0!=i.length))return thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.jsonapi] No Template found for object with ID ["+e.id+"]"),void $("#"+e.id).hide();if(i&&0!=i.length||(i=1!=a?jsonApiPlugin.getRepeaterTemplate(r):r.outerHTML,$("#"+e.id).data("template",i)),"1"!=a)thoriumCorePlugin.renderVirtualListFromData(e,t,i);else if(t.length>0){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Render Collection for Repeater with ID ["+e.id+"]"),$("#"+e.id).data("items",t);var n,o=e.parentNode.getAttribute("data-img-root")||"",l=0;for(var u in t)n=(n=(n=(n=(n=(n=jsonApiPlugin.getCollectionRow("",t[u],i)).replace("url({data-img-root})","url(./img/defaultimg.png)")).replaceAll("templaterow","")).replaceAll("template-"+e.id,"template-"+e.id+"-"+l)).replaceAll("{data-img-root}",o)).replaceAll("'"+o+"'","./img/defaultimg.png"),e.innerHTML=e.innerHTML+n,l+=1;e.setAttribute("data-loaded",!0),e.setAttribute("data-count",t.length)}},getChildrenProperty:function(e,t){var i;for(var a in e){if(a==t){i=e[a];break}if(e.hasOwnProperty(a)&&!i&&"object"==typeof e[a]&&null!==e[a]&&(i=jsonApiPlugin.getChildrenProperty(e[a],t)),i)break}if(null!=i)return i},getRepeaterData:function(e,t,i,a){a=a||!1;var r="",n=[];r=t;var o=$("#"+e.id);if(o){var l=app.virtualList.get(o);l&&app.virtualList.destroy(l),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Get data for Repeater with ID ["+e.id+"] from url ["+r+"]");var u=o.closest(".page-content");if(u&&(app.preloader.hide(),app.preloader.showIn(u),setTimeout((function(){u&&app.preloader.hideIn(u)}),4e3)),jsonApiPlugin.currentRepeaterId=null,e){var s=e.closest(".json-virtual-list");s&&(jsonApiPlugin.currentRepeaterId=s.id)}var p={},d={},c=!1;p.method="GET",kMode.length>0&&(p.mode=kMode),kCache.length>0&&(p.cache=kCache),kCredentials.length>0&&(p.credentials=kCredentials),kContenttype.length>0&&(d["Content-Type"]=kContenttype,c=!0),kRedirect.length>0&&(d.redirect=kRedirect,c=!0),kReferrerpolicy.length>0&&(d.referrerpolicy=kReferrerpolicy,c=!0),kAuthorization.length>0&&(d.Authorization=kAuthorization,c=!0),1==c&&(p.headers=d);var g=window.callback_repeater_before_load,m=[p];"function"==typeof g&&(p=g.apply(this,m));var h=e.getAttribute("data-dummy-param")||null;if(h&&"true"==h){const e=Math.floor(Date.now()/1e3);r=-1==r.indexOf("?")?r+"?rnd="+e:r+"&rnd="+e}fetch(r,p).then((function(t){t.text().then((a=>{if(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Got Response from url ["+r+"]"),0==a.length)return thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.jsonapi] Empty Result. Maybe a CORS issue. Status ["+t.status+"] :"+t.statusText),e.classList.remove("loadingdata"),void(u&&app.preloader.hideIn(u));var o;try{o=JSON.parse(a)}catch(e){return thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] "+e.message),app.emit("jsonDataloadError",$(this),e),u&&app.preloader.hideIn(u),void app.dialog.alert(e.message+" "+a)}var l,s=0,p={};if(l="object"==typeof o&&i?jsonApiPlugin.getChildrenProperty(o,i):i?o[i]:o)for(var d in l)(p=l[d]).dataindex=s,s+=1,n.push(p);jsonApiPlugin.setRepeaterDataContent(e,n),app.emit("jsonDataloadSuccess",$(this),e,n),u&&app.preloader.hideIn(u)})).catch((function(t){thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] "+t.message),e.classList.remove("loadingdata"),$("#"+e.id).hide(),app.dialog.alert(t.message)}))})).catch((function(t){thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] "+t.message),u&&app.preloader.hideIn(u),$("#"+e.id).hide(),app.emit("jsonDataloadError",$(this),t),0==app.online?thoriumCorePlugin.showNotification("Internet connection lost"):app.dialog.alert(t.message)}))}},initAllRepeaters:function(e,t){t=t||!1,thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Checking Repeaters State"),$(".json-virtual-list-content").each((function(i){if("true"!=i.getAttribute("data-loaded")){var a=$(this).attr("data-source")||null;"js/json/"==a&&(a=null),e&&a&&(a=a.replaceAll("{key}",e));var r=$(this).attr("data-root-field")||null;a&&(jsonApiPlugin.getRepeaterData(i,a,r,t),$("#view-main").show())}}))},getDisplayerData:function(e,t,i){var a=$("#"+i.id).closest(".page-content");a&&(app.preloader.hide(),app.preloader.showIn(a),setTimeout((function(){a&&app.preloader.hideIn(a)}),4e3));var r=e.replaceAll("{key}",t);thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Get Displayer Data from url ["+r+"]");var n={},o={},l=!1;n.method="GET",kMode.length>0&&(n.mode=kMode),kCache.length>0&&(n.cache=kCache),kCredentials.length>0&&(n.credentials=kCredentials),kContenttype.length>0&&(o["Content-Type"]=kContenttype,l=!0),kRedirect.length>0&&(o.redirect=kRedirect,l=!0),kReferrerpolicy.length>0&&(o.referrerpolicy=kReferrerpolicy,l=!0),kAuthorization.length>0&&(o.Authorization=kAuthorization,l=!0),1==l&&(n.headers=o),jsonApiPlugin.currentDisplayerId=null,i&&(jsonApiPlugin.currentDisplayerId=i.id);var u=window.callback_displayer_before_load,s=[n];"function"==typeof u&&(n=u.apply(this,s)),fetch(r,n).then((function(e){200!==e.status?(a&&app.preloader.hideIn(a),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] url ["+r+"] returned status ["+e.status+"] "),app.emit("jsonDataloadError",$(this),e),app.dialog.alert(e.status)):e.text().then((e=>{var t;try{t=JSON.parse(e)}catch(t){return thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] url ["+r+"] returned ["+t.message+"] "),app.emit("jsonDataloadError",$(this),t),void app.dialog.alert(t.message+"<br>"+e)}var n={};for(var o in t){if("object"==typeof t[o]&&null!==t[o])n=jsonApiPlugin.parseDataRecursive(o,t[o],n);else n[o.replaceAll(" ","_")]=t[o]}thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Data loaded from url ["+r+"]"),app.emit("jsonDataloadSuccess",$(this),i,n),jsonApiPlugin.setDisplayerDataContent(i,n),$("#"+i.id).data("item",n),$("#"+i.id).show(),a&&app.preloader.hideIn(a)})).catch((function(e){$("#"+i.id).hide(),a&&app.preloader.hideIn(a),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] url ["+r+"] returned ["+e.message+"] "),app.emit("jsonDataloadError",$(this),e),app.dialog.alert(e.message)}))})).catch((function(e){thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] url ["+r+"] returned ["+e.message+"] "),app.emit("jsonDataloadError",$(this),e),$("#"+i.id).hide(),a&&app.preloader.hideIn(a),0==app.online?thoriumCorePlugin.showNotification("Internet connection lost"):app.dialog.alert(e.message)}))},repeaterLineClick:function(e,t){var i=t.attr("data-index")||null,a=t.attr("data-key")||null;if(i){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Detect Click/Touch on line ["+i+"]");var r=t.parents(".json-virtual-list-content");if(r){var n=app.virtualList.get("#"+r[0].id),o=r.attr("data-detail")||null;if(o){e.preventDefault();var l=n.items[i];if(l){var u=app.view;u&&u.length>0&&u[0].router.navigate("/"+o+"/?rowindex="+i+"&key="+a+"&data="+encodeURIComponent(JSON.stringify(l)))}}}}},collectionrepeaterLineClick:function(e,t){var i=t.attr("data-index")||null,a=t.attr("data-key")||null;if(i){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Detect Click/Touch on line ["+i+"]");var r=t.parents(".json-virtual-list-content");if(r){var n=r.data("items"),o=r.attr("data-detail")||null,l=n[i],u=app.view;u&&u.length>0&&u[0].router.navigate("/"+o+"/?rowindex="+i+"&data="+encodeURIComponent(JSON.stringify(l))+"&key="+a)}}},initAllDisplayers:function(e,t){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Checking JSON Displayer State"),$(".json-form").each((function(i){if("true"!=i.getAttribute("data-loaded")){var a=$(this).attr("data-custom-api")||null;a?jsonApiPlugin.getDisplayerData(a,e,i):jsonApiPlugin.setDisplayerDataContent(i,t)}}))},setRepeaterFilter:function(e,t){var i=t.attr("data-filter-virtuallist")||null;if(app.virtualList.get("#"+i)){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Set New Filter for Repeater with ID ["+i+"]"),document.getElementById(i).setAttribute("data-loaded",!1),document.getElementById(i).setAttribute("data-count",0);var a=t.attr("data-source");a&&(document.getElementById(i).setAttribute("data-source",a),jsonApiPlugin.initAllRepeaters(null))}else{var r="An error occured, the Json Repeater is not initialized";thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.jsonapi] "+r),app.dialog.alert(r)}},repeaterLineButtonClick:function(e,t){var i=t.attr("data-index")||null,a=t.attr("data-key")||null,r=t.attr("data-target")||null,n=t.attr("data-transition")||null;if(i){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Detect Click/Touch on Line ["+i+"]");var o=t.parents(".json-virtual-list-content");if(o&&o.length>0){var l=app.virtualList.get("#"+o[0].id);if(l){var u=l.items[i],s=app.view,p=t.closest(".virtual-list")||null,d=null;p&&(d=p[0].id),s&&s.length>0&&(app.emit("VirtualListLineClick",t,i,u,r),s[0].router.navigate("/"+r+"/?rowindex="+i+"&data="+encodeURIComponent(JSON.stringify(u))+"&key="+a+"&parentvlid="+d,{animate:!0,transition:n,reloadAll:!1}))}}}},getFlatFormData:function(e,t,i){for(var a in t){if("object"==typeof t[a]&&null!==t[a])if(Array.isArray(t[a]))i[a.replaceAll(" ","_")]=t[a];else jsonApiPlugin.getFlatFormData(e+"."+a,t[a],i);else i[e+"."+a.replaceAll(" ","_")]=t[a]}return i},setJsonFormData:function(e,t,i){if(t&&!0!==e.getAttribute("data-loaded")){var a={},r={};for(var n in t){if("object"==typeof t[n]&&null!==t[n])r=jsonApiPlugin.getFlatFormData(n,t[n],r);else r[n.replaceAll(" ","_")]=t[n]}thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Set JSON Form Data for form with ID ["+e.id+"]");for(let[e,t]of Object.entries(r)){var o=e;!0===["name","id","description","this","title","submit"].includes(o)&&(o+="_alias");var l=document.getElementsByName(o)[0];if(l){var u=l.classList.contains("shadow-text");if("checkbox"==l.type)"true"===t||!0===t||"1"===t||"on"===t?(a[o]="on",l.setAttribute("checked","checked")):(a[o]="off",l.removeAttribute("checked"));else if("select-one"==l.type||"select"==l.tagName.toLowerCase){$("#"+l.id).attr("data-value",t);var s=$("#"+l.id).closest(".smart-select");if(s&&s.length>0){var p=app.smartSelect.get(s);p&&p.setValue(t)}else{$("#"+l.id).val(t),0==$("#"+l.id).html().trim().length&&$("#"+l.id).html('<option value="'+t+'">'+t+"</option>")}a[e]=t}else if("image"==l.type)$("#"+l.id+"-fileinput-filename").css("visibility","hidden"),t&&t.length>0&&($("#"+l.id).css("background-image","url("+t+")"),$("#"+l.id+"-fileinput-filename span").text(t),$("#"+l.id+"-remove").show());else if("range"==l.type){a[e]=t;var d=app.range.get(l.parentElement);d?d.setValue(t):(d=app.range.create(l.parentElement)).setValue(t)}else if(1==u){a[e]=t;var c=l.id.replaceAll("-shadow",""),g=app.textEditor.get("#"+c);g&&g.setValue(t)}else if("text"==l.type)l.value=t;else if("textarea"==l.type)l.value=t;else if("radio"==l.type)for(var m=l.closest("ul"),h=l.getAttribute("name"),f=m.querySelectorAll("input[name='"+h+"']"),v=0;v<f.length;v++){const e=f[v];e.value==t?e.setAttribute("checked","checked"):e.removeAttribute("checked")}else if("file"==l.type){var A=l.getAttribute("data-fileinput-ref"),b=$("#"+A);if(b&&b.length>0){$("#"+A+"-fileinput-filename span");$("#"+A+"-fileinput-filename").show(),$("#"+A+"-fileinput-filename").css("visibility","visible"),$("#"+A+"-fileinput-filename span").text(t),$("#"+A+"-fileinput-filename i").show(),$("#"+A+"-fileinput-link").show(),$("#"+A+"-fileinput-link span").html('<a class="external" target="_blank" rel="noopener" data-rel="external" target="_blank" href="'+t+'">See attached file</a>'),t.length>0?$("#"+A+"-remove").show():$("#"+A+"-fileinput-filename").css("visibility","hidden")}a[e]=t}else a[e]=t,l.value=t}}app.form.fillFromData("#"+e.id,a),e.setAttribute("data-loaded",!0),e.setAttribute("data-parent-key",i)}},initAllJsonWidgets:function(e){var t,i,a,r=e.detail;if(r===page?elt=app.root:(elt=r.$el,t=r.route),elt&&t){var n;if(i=t.query.data||null,t.query.rowindex||null,a=t.query.key||null,thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Get Page Parameters"),i)try{n=JSON.parse(i)}catch(e){var o="[com.thoriumbuilder.jsonapi] Get Page Parameters, Unable to Parse data parameter Json:"+e.message;return thoriumCorePlugin.logEvent(2,o),void app.dialog.alert(o)}jsonApiPlugin.initAllDisplayers(a,n),jsonApiPlugin.initAllRepeaters(a),$(".form[data-from-repeater='true']").each((function(e){0==e.classList.contains("firebase-data-form")&&jsonApiPlugin.setJsonFormData(e,n,a)}))}},initialize:function(){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.jsonapi] Initialize JSON API"),jsonApiPlugin.initAllRepeaters(null),jsonApiPlugin.initAllDisplayers()}};$(document).on("click",".item-json",(function(e){e.preventDefault(),jsonApiPlugin.repeaterLineClick(e,$(this))})),$(document).on("click","a.collection-item-json",(function(e){e.preventDefault(),jsonApiPlugin.collectionrepeaterLineClick(e,$(this))})),$(document).on("click","a.btn-json-filter",(function(e){e.preventDefault(),jsonApiPlugin.setRepeaterFilter(e,$(this))})),$(document).on("click","a.btn-json-page",(function(e){e.preventDefault(),jsonApiPlugin.repeaterLineButtonClick(e,$(this))})),$(document).on("page:mounted",(function(e){e.preventDefault,jsonApiPlugin.initAllJsonWidgets(e)})),document.addEventListener("deviceready",jsonApiPlugin.initialize),document.addEventListener("DOMContentLoaded",jsonApiPlugin.initialize);